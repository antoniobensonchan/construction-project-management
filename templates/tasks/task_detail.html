{% extends 'base.html' %}
{% load static %}

{% block title %}{{ task.name }} - 任务详情{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-tasks"></i> {{ task.name }}
                    <span class="badge bg-secondary ms-2">{{ task.get_task_type_display }}</span>
                </h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">任务名称：</dt>
                    <dd class="col-sm-9">{{ task.name }}</dd>

                    <dt class="col-sm-3">任务类型：</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-secondary">{{ task.get_task_type_display }}</span>
                    </dd>

                    <dt class="col-sm-3">负责人：</dt>
                    <dd class="col-sm-9">{{ task.responsible_person }}</dd>

                    <dt class="col-sm-3">截止时间：</dt>
                    <dd class="col-sm-9">
                        {{ task.deadline|date:"Y年m月d日" }}
                        {% if task.deadline < today %}
                            <span class="badge bg-danger ms-2">已逾期</span>
                        {% elif task.deadline == today %}
                            <span class="badge bg-warning ms-2">今日截止</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-3">创建时间：</dt>
                    <dd class="col-sm-9">{{ task.created_at|date:"Y-m-d H:i:s" }}</dd>

                    <dt class="col-sm-3">更新时间：</dt>
                    <dd class="col-sm-9">{{ task.updated_at|date:"Y-m-d H:i:s" }}</dd>

                    <!-- 任务进度条 -->
                    {% with progress=task.get_progress_percentage %}
                    <dt class="col-sm-3">任务进度：</dt>
                    <dd class="col-sm-9">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar
                                    {% if progress == 100 %}bg-success
                                    {% elif progress >= 75 %}bg-info
                                    {% elif progress >= 50 %}bg-warning
                                    {% else %}bg-danger
                                    {% endif %}"
                                    role="progressbar"
                                    style="width: {{ progress }}%"
                                    aria-valuenow="{{ progress }}"
                                    aria-valuemin="0"
                                    aria-valuemax="100">
                                    <span class="fw-bold">{{ progress }}%</span>
                                </div>
                            </div>
                        </div>
                        {% with stats=task.get_subtask_stats %}
                        {% if stats.total > 0 %}
                        <small class="text-muted">
                            子任务: {{ stats.completed }}/{{ stats.total }} 已完成
                            {% if stats.in_progress > 0 %}, {{ stats.in_progress }} 进行中{% endif %}
                            {% if stats.pending > 0 %}, {{ stats.pending }} 待处理{% endif %}
                            {% if stats.open > 0 %}, {{ stats.open }} 开放{% endif %}
                        </small>
                        {% else %}
                        <small class="text-muted">基于任务状态的进度</small>
                        {% endif %}
                        {% endwith %}
                    </dd>
                    {% endwith %}
                </dl>
            </div>
        </div>

        <!-- 子任务管理 -->
        {% if task.subtasks.exists or not task.parent_task %}
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-ul"></i> 子任务管理
                </h5>
                {% if not task.parent_task %}
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSubtaskModal">
                    <i class="fas fa-plus"></i> 添加子任务
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if task.subtasks.exists %}
                <div id="subtask-list">
                    {% for subtask in task.subtasks.all %}
                    <div class="subtask-item border rounded p-3 mb-3" data-subtask-id="{{ subtask.id }}">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">{{ subtask.name }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-user"></i> {{ subtask.responsible_person }} |
                                    <i class="fas fa-calendar"></i> {{ subtask.deadline|date:"Y-m-d" }}
                                </small>
                                {% if subtask.description %}
                                <p class="small text-muted mt-1 mb-0">{{ subtask.description }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-3">
                                <select class="form-select form-select-sm subtask-status" data-subtask-id="{{ subtask.id }}">
                                    <option value="open" {% if subtask.status == 'open' %}selected{% endif %}>开放</option>
                                    <option value="in_progress" {% if subtask.status == 'in_progress' %}selected{% endif %}>进行中</option>
                                    <option value="pending" {% if subtask.status == 'pending' %}selected{% endif %}>待处理</option>
                                    <option value="completed" {% if subtask.status == 'completed' %}selected{% endif %}>已完成</option>
                                </select>
                            </div>
                            <div class="col-md-3 text-end">
                                <span class="badge
                                    {% if subtask.status == 'completed' %}bg-success
                                    {% elif subtask.status == 'in_progress' %}bg-warning
                                    {% elif subtask.status == 'pending' %}bg-info
                                    {% else %}bg-secondary
                                    {% endif %}">
                                    {{ subtask.get_status_display }}
                                </span>
                                <button type="button" class="btn btn-outline-danger btn-sm ms-2 delete-subtask" data-subtask-id="{{ subtask.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list-ul fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">还没有子任务</h6>
                    <p class="text-muted">点击"添加子任务"按钮创建第一个子任务</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 工地图纸及标注 -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-pdf text-danger"></i> 工地图纸及标注
                </h5>
                {% if task.annotations.exists %}
                <span class="badge bg-primary">{{ task.annotations.count }} 个标注</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-1">工地图纸 ({{ worksite_drawings.count }})</h6>
                        {% if worksite_drawings.exists %}
                            {% for drawing in worksite_drawings %}
                            <div class="mb-2">
                                <strong>{{ drawing.name }}</strong>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar"></i> 上传：{{ drawing.uploaded_at|date:"Y-m-d H:i" }} |
                                    <i class="fas fa-weight-hanging"></i> {{ drawing.file_size_mb }} MB |
                                    <i class="fas fa-file"></i> {{ drawing.page_count }} 页
                                </small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">此工地还没有图纸</small>
                            {% if worksite %}
                            <div class="mt-2">
                                <a href="{% url 'drawings:worksite_drawing_upload' worksite.pk %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-plus me-1"></i>上传工地图纸
                                </a>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-grid gap-2">
                            {% if worksite_drawings.exists %}
                                {% for drawing in worksite_drawings %}
                                <a href="{% url 'drawings:drawing_detail' drawing.pk %}"
                                   class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> 查看{{ drawing.name }}
                                </a>
                                {% endfor %}
                            {% endif %}
                            {% if task.annotations.exists %}
                            <button class="btn btn-success btn-sm" id="download-with-annotations">
                                <i class="fas fa-download"></i> 下载含标注图纸
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- PDF预览区域（含标注） -->
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="me-3">工地图纸预览</span>
                                    {% if worksite_drawings.count > 1 %}
                                    <div class="d-flex align-items-center">
                                        <label for="drawing-selector" class="form-label me-2 mb-0 small">选择图纸:</label>
                                        <select class="form-select form-select-sm" id="drawing-selector" style="width: auto;">
                                            {% for drawing in worksite_drawings %}
                                            <option value="{{ drawing.pk }}"
                                                    data-url="{{ drawing.file.url }}"
                                                    data-name="{{ drawing.name }}"
                                                    data-type="{% if drawing.file.url|slice:'-4:' == '.pdf' %}pdf{% else %}image{% endif %}">
                                                {{ drawing.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% elif worksite_drawings.count == 1 %}
                                    <span class="text-muted small">{{ worksite_drawings.first.name }}</span>
                                    {% else %}
                                    <span class="text-muted small">无工地图纸</span>
                                    {% endif %}
                                </div>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" id="toggle-annotations">
                                        <i class="fas fa-eye"></i> 显示/隐藏标注
                                    </button>
                                    <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i> 编辑标注
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="pdf-container" style="height: 400px; overflow: auto; position: relative;">
                                <div id="pdf-loading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载图纸...</p>
                                </div>

                                <!-- 文件查看器和标注层 -->
                                {% if worksite_drawings.exists %}
                                <div id="file-viewer-wrapper" style="position: relative;">
                                    <!-- PDF查看器 -->
                                    <embed id="pdf-viewer"
                                           src="{{ worksite_drawings.first.file.url }}"
                                           type="application/pdf"
                                           width="100%"
                                           height="400px"
                                           style="display: {% if worksite_drawings.first.file.url|slice:'-4:' == '.pdf' %}block{% else %}none{% endif %};">

                                    <!-- 图片查看器 -->
                                    <img id="image-viewer"
                                         src="{{ worksite_drawings.first.file.url }}"
                                         style="width: 100%; max-height: 400px; object-fit: contain; object-position: left top; display: {% if worksite_drawings.first.file.url|slice:'-4:' != '.pdf' %}block{% else %}none{% endif %};"
                                         alt="{{ worksite_drawings.first.name }}">

                                    <!-- 标注层 -->
                                    <div id="annotation-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 400px; z-index: 2; pointer-events: none;">
                                        <!-- 标注将在这里显示 -->
                                    </div>
                                </div>
                                {% else %}
                                <!-- 无图纸时的显示 -->
                                <div class="text-center py-5">
                                    <i class="fas fa-file-image fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">此工地还没有图纸</p>
                                    {% if worksite %}
                                    <a href="{% url 'drawings:worksite_drawing_upload' worksite.pk %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>上传工地图纸
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <div id="pdf-error" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                                    <h6>图纸加载失败</h6>
                                    <p class="text-muted small">请刷新页面重试</p>
                                </div>
                            </div>
                        </div>

                        <!-- 页码导航 -->
                        {% if task.drawings.exists and task.drawings.first.page_count > 1 %}
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" id="prev-page" disabled>
                                    <i class="fas fa-chevron-left"></i> 上一页
                                </button>

                                <div class="d-flex align-items-center gap-2">
                                    <span>第</span>
                                    <select class="form-select form-select-sm" id="page-select" style="width: auto;">
                                        {% load drawing_extras %}
                                        {% for page_num in task.drawings.first.page_count|range_from:1 %}
                                        <option value="{{ page_num }}" {% if page_num == 1 %}selected{% endif %}>{{ page_num }}</option>
                                        {% endfor %}
                                    </select>
                                    <span>页，共 {{ task.drawings.first.page_count }} 页</span>
                                </div>

                                <button class="btn btn-sm btn-outline-secondary" id="next-page" {% if task.drawing.page_count == 1 %}disabled{% endif %}>
                                    下一页 <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 标注列表 -->
                {% if task.annotations.exists %}
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list"></i> 标注列表
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for annotation in task.annotations.all %}
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                {% if annotation.is_point %}
                                                    <i class="fas fa-circle text-danger"></i>
                                                {% elif annotation.is_rectangle %}
                                                    <i class="fas fa-square text-danger"></i>
                                                {% elif annotation.is_text %}
                                                    <i class="fas fa-font text-danger"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ annotation.get_annotation_type_display }}</h6>
                                                <p class="mb-2 text-muted small">{{ annotation.content }}</p>
                                                <small class="text-muted">
                                                    第{{ annotation.page_number }}页
                                                    ({{ annotation.x_coordinate|floatformat:0 }}, {{ annotation.y_coordinate|floatformat:0 }})
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs"></i> 操作
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if task.drawings.exists %}
                        {% for drawing in task.drawings.all %}
                        <a href="{% url 'drawings:drawing_detail' drawing.pk %}"
                           class="btn btn-primary mb-2">
                            <i class="fas fa-eye"></i> 查看{{ drawing.name }}
                        </a>

                        <a href="{{ drawing.file.url }}"
                           class="btn btn-success mb-2"
                           download="{{ drawing.name }}.pdf">
                            <i class="fas fa-download"></i> 下载{{ drawing.name }}
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            此任务没有关联图纸
                        </div>
                    {% endif %}

                    <hr>

                    {% if task.project %}
                    <a href="{% url 'projects:project_detail' task.project.pk %}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回项目
                    </a>
                    {% else %}
                    <a href="{% url 'tasks:task_list' %}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回任务列表
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 任务统计信息 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar"></i> 任务信息
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary mb-1">
                                {% now "Y-m-d"|date:"Y-m-d" as today %}
                                {% if task.deadline >= today %}
                                    {{ task.deadline|timeuntil }}
                                {% else %}
                                    已逾期
                                {% endif %}
                            </h4>
                            <small class="text-muted">剩余时间</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info mb-1">{{ task.created_at|timesince }}</h4>
                        <small class="text-muted">创建时间</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加子任务模态框 -->
<div class="modal fade" id="addSubtaskModal" tabindex="-1" aria-labelledby="addSubtaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubtaskModalLabel">
                    <i class="fas fa-plus"></i> 添加子任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subtaskForm">
                    <div class="mb-3">
                        <label for="subtaskName" class="form-label">子任务名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subtaskName" name="name" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="subtaskDescription" class="form-label">子任务描述</label>
                        <textarea class="form-control" id="subtaskDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskType" class="form-label">任务类型</label>
                                <select class="form-select" id="subtaskType" name="task_type">
                                    <option value="new_construction" {% if task.task_type == 'new_construction' %}selected{% endif %}>新建施工</option>
                                    <option value="repair" {% if task.task_type == 'repair' %}selected{% endif %}>整改修复</option>
                                    <option value="inspection" {% if task.task_type == 'inspection' %}selected{% endif %}>检查验收</option>
                                    <option value="maintenance" {% if task.task_type == 'maintenance' %}selected{% endif %}>维护保养</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskStatus" class="form-label">初始状态</label>
                                <select class="form-select" id="subtaskStatus" name="status">
                                    <option value="open" selected>开放</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="pending">待处理</option>
                                    <option value="completed">已完成</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskResponsible" class="form-label">负责人 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subtaskResponsible" name="responsible_person" required maxlength="100" value="{{ task.responsible_person }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskStatus" class="form-label">初始状态</label>
                                <select class="form-select" id="subtaskStatus" name="status">
                                    <option value="open" selected>开放</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="pending">待处理</option>
                                    <option value="completed">已完成</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 子任务日期计划 -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskStartDate" class="form-label">开始日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskStartDate" name="start_date" required value="{{ task.start_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskEndDate" class="form-label">结束日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskEndDate" name="end_date" required value="{{ task.end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskDeadline" class="form-label">截止时间 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskDeadline" name="deadline" required value="{{ task.deadline|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveSubtaskBtn">
                    <i class="fas fa-save"></i> 保存子任务
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfViewer = document.getElementById('pdf-viewer');
    const imageViewer = document.getElementById('image-viewer');
    const pdfLoading = document.getElementById('pdf-loading');
    const pdfError = document.getElementById('pdf-error');
    const annotationLayer = document.getElementById('annotation-layer');
    const toggleAnnotationsBtn = document.getElementById('toggle-annotations');
    const downloadBtn = document.getElementById('download-with-annotations');
    const fileViewerWrapper = document.getElementById('file-viewer-wrapper');
    const drawingSelector = document.getElementById('drawing-selector');

    let currentPage = 1;
    let totalPages = {% if worksite_drawings.exists %}{{ worksite_drawings.first.page_count }}{% else %}1{% endif %};
    let annotationsVisible = true;
    const fileType = "{% if worksite_drawings.exists %}{{ worksite_drawings.first.file_type }}{% else %}pdf{% endif %}";

    // 页码控制元素
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageSelect = document.getElementById('page-select');

    // 标注数据
    const annotations = [
        {% for annotation in task.annotations.all %}
        {
            type: '{{ annotation.annotation_type }}',
            page: {{ annotation.page_number }},
            drawing_id: {{ annotation.drawing.pk|default:"null" }},
            x: {{ annotation.x_coordinate }},
            y: {{ annotation.y_coordinate }},
            {% if annotation.end_x %}end_x: {{ annotation.end_x }},{% endif %}
            {% if annotation.end_y %}end_y: {{ annotation.end_y }},{% endif %}
            {% if annotation.width %}width: {{ annotation.width }},{% endif %}
            {% if annotation.height %}height: {{ annotation.height }},{% endif %}
            color: '{{ annotation.color|default:"red" }}',
            content: '{{ annotation.content|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('=== Task Detail Page Debug ===');
    console.log('Task ID: {{ task.id }}');
    console.log('Worksite drawings count: {{ worksite_drawings.count }}');
    {% if worksite_drawings.exists %}
    console.log('First drawing file type: {{ worksite_drawings.first.file_type }}');
    console.log('First drawing ID: {{ worksite_drawings.first.pk }}');
    {% endif %}
    console.log('Total annotations from database:', annotations.length);
    console.log('Annotations data:', annotations);
    console.log('================================');

    // 图纸选择功能
    if (drawingSelector) {
        drawingSelector.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const drawingUrl = selectedOption.dataset.url;
            const drawingName = selectedOption.dataset.name;
            const drawingType = selectedOption.dataset.type;

            console.log('Switching to drawing:', drawingName, 'Type:', drawingType);

            if (drawingType === 'pdf') {
                // 显示PDF查看器
                if (pdfViewer) {
                    pdfViewer.src = drawingUrl;
                    pdfViewer.style.display = 'block';
                }
                if (imageViewer) {
                    imageViewer.style.display = 'none';
                }
            } else {
                // 显示图片查看器
                if (imageViewer) {
                    imageViewer.src = drawingUrl;
                    imageViewer.alt = drawingName;
                    imageViewer.style.display = 'block';
                }
                if (pdfViewer) {
                    pdfViewer.style.display = 'none';
                }
            }

            // 重新渲染标注
            renderAnnotations();
        });
    }

    // 根据文件类型加载对应的查看器
    console.log('File type:', fileType);
    console.log('PDF Viewer:', pdfViewer);
    console.log('Image Viewer:', imageViewer);
    console.log('File Viewer Wrapper:', fileViewerWrapper);

    if (fileType === 'pdf') {
        // PDF文件处理
        console.log('Loading PDF file');
        if (pdfViewer && fileViewerWrapper) {
            pdfViewer.style.display = 'block';
            if (imageViewer) imageViewer.style.display = 'none';

            pdfViewer.addEventListener('load', function() {
                console.log('PDF loaded successfully');
                pdfLoading.style.display = 'none';
                fileViewerWrapper.style.display = 'block';
                renderAnnotations();
            });

            pdfViewer.addEventListener('error', function() {
                console.log('PDF load error');
                pdfLoading.style.display = 'none';
                pdfError.style.display = 'block';
            });
        }
    } else {
        // 图片文件处理
        console.log('Loading image file');
        if (imageViewer && fileViewerWrapper) {
            imageViewer.style.display = 'block';
            if (pdfViewer) pdfViewer.style.display = 'none';

            // 立即尝试加载图片
            console.log('Image src:', imageViewer.src);

            imageViewer.addEventListener('load', function() {
                console.log('Image loaded successfully');
                pdfLoading.style.display = 'none';
                fileViewerWrapper.style.display = 'block';
                renderAnnotations();
            });

            imageViewer.addEventListener('error', function() {
                console.log('Image load error');
                pdfLoading.style.display = 'none';
                pdfError.style.display = 'block';
            });

            // 强制触发加载检查
            setTimeout(() => {
                if (imageViewer.complete && imageViewer.naturalWidth > 0) {
                    console.log('Image already loaded, showing immediately');
                    pdfLoading.style.display = 'none';
                    fileViewerWrapper.style.display = 'block';
                    renderAnnotations();
                } else {
                    console.log('Image still loading...');
                }
            }, 1000);
        }
    }

    // 页码导航功能
    if (totalPages > 1 && prevPageBtn && nextPageBtn && pageSelect) {
        // 上一页
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updatePage();
            }
        });

        // 下一页
        nextPageBtn.addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePage();
            }
        });

        // 页码选择
        pageSelect.addEventListener('change', function() {
            currentPage = parseInt(this.value);
            updatePage();
        });

        // 更新页面显示
        function updatePage() {
            // 更新PDF显示
            const baseUrl = '{{ task.drawing.file.url }}';
            pdfViewer.src = `${baseUrl}#page=${currentPage}`;

            // 更新页码选择器
            pageSelect.value = currentPage;

            // 更新按钮状态
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;

            // 重新渲染当前页的标注
            renderAnnotations();
        }
    }

    // 获取当前选择的图纸ID
    function getCurrentDrawingId() {
        const drawingSelector = document.getElementById('drawing-selector');
        if (drawingSelector && drawingSelector.options.length > 0) {
            return parseInt(drawingSelector.value);
        } else if ({{ worksite_drawings.count }} === 1) {
            return {{ worksite_drawings.first.pk }};
        }
        return null;
    }

    // 渲染标注
    function renderAnnotations() {
        console.log('Rendering annotations...');
        console.log('Annotation layer:', annotationLayer);
        console.log('Annotations visible:', annotationsVisible);
        console.log('Current page:', currentPage);
        console.log('Total annotations:', annotations.length);

        if (!annotationLayer) {
            console.error('Annotation layer not found');
            return;
        }

        // 清除现有标注
        annotationLayer.innerHTML = '';

        if (!annotationsVisible) {
            console.log('Annotations hidden');
            return;
        }

        // 获取当前选择的图纸ID
        const currentDrawingId = getCurrentDrawingId();
        console.log('Current drawing ID:', currentDrawingId);

        // 渲染当前页和当前图纸的标注
        const currentAnnotations = annotations.filter(a =>
            a.page === currentPage &&
            (a.drawing_id === currentDrawingId || (a.drawing_id === null && currentDrawingId === null))
        );
        console.log('Current page and drawing annotations:', currentAnnotations);

        currentAnnotations.forEach((annotation, index) => {
            console.log(`Rendering annotation ${index}:`, annotation);
            let element;

            const color = annotation.color || 'red';
            const darkerColor = getDarkerColor(color);

            if (annotation.type === 'point') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x - 6}px;
                    top: ${annotation.y - 6}px;
                    width: 12px;
                    height: 12px;
                    background-color: ${color};
                    border: 2px solid ${darkerColor};
                    border-radius: 50%;
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;
                element.title = annotation.content;
                console.log('Created point element');
            } else if (annotation.type === 'line') {
                // 创建线条标记
                element = document.createElement('div');
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');

                const endX = annotation.end_x || annotation.x;
                const endY = annotation.end_y || annotation.y;
                const minX = Math.min(annotation.x, endX);
                const minY = Math.min(annotation.y, endY);
                const maxX = Math.max(annotation.x, endX);
                const maxY = Math.max(annotation.y, endY);
                const width = maxX - minX + 10;
                const height = maxY - minY + 10;

                element.style.cssText = `
                    position: absolute;
                    left: ${minX - 5}px;
                    top: ${minY - 5}px;
                    width: ${width}px;
                    height: ${height}px;
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;

                svg.style.cssText = `width: 100%; height: 100%;`;

                line.setAttribute('x1', annotation.x - minX + 5);
                line.setAttribute('y1', annotation.y - minY + 5);
                line.setAttribute('x2', endX - minX + 5);
                line.setAttribute('y2', endY - minY + 5);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', '3');
                line.setAttribute('stroke-linecap', 'round');

                svg.appendChild(line);
                element.appendChild(svg);
                element.title = annotation.content;
                console.log('Created line element');
            } else if (annotation.type === 'rectangle') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x}px;
                    top: ${annotation.y}px;
                    width: ${annotation.width}px;
                    height: ${annotation.height}px;
                    border: 2px solid red;
                    background: rgba(255, 0, 0, 0.1);
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;
                element.title = annotation.content;
                console.log('Created rectangle element');
            } else if (annotation.type === 'text') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x}px;
                    top: ${annotation.y - 16}px;
                    color: red;
                    font-weight: bold;
                    font-size: 12px;
                    background: white;
                    padding: 2px 6px;
                    border-radius: 3px;
                    border: 1px solid red;
                    cursor: pointer;
                    pointer-events: auto;
                    max-width: 150px;
                    word-wrap: break-word;
                    z-index: 10;
                `;
                element.textContent = annotation.content;
                console.log('Created text element');
            }

            if (element) {
                annotationLayer.appendChild(element);
                console.log('Annotation element added to layer');
            }
        });

        console.log('Annotation rendering complete');
    }

    // 获取更深的颜色
    function getDarkerColor(color) {
        const colorMap = {
            'red': 'darkred',
            'blue': 'darkblue',
            'green': 'darkgreen',
            'yellow': 'orange',
            'orange': 'darkorange',
            'purple': 'darkviolet',
            'black': 'black'
        };
        return colorMap[color] || 'black';
    }

    // 切换标注显示
    if (toggleAnnotationsBtn) {
        toggleAnnotationsBtn.addEventListener('click', function() {
            annotationsVisible = !annotationsVisible;
            renderAnnotations();

            if (annotationsVisible) {
                this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏标注';
            } else {
                this.innerHTML = '<i class="fas fa-eye"></i> 显示标注';
            }
        });
    }

    // 下载含标注的PDF（模拟功能）
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            // 这里应该调用后端API生成含标注的PDF
            // 目前先提供原PDF下载
            const link = document.createElement('a');
            link.href = '{{ task.drawing.file.url }}';
            link.download = '{{ task.drawing.name }}_含标注.pdf';
            link.click();

            // 显示提示
            alert('注意：当前下载的是原始PDF文件。含标注PDF生成功能将在后续版本中实现。');
        });
    }

    // 子任务管理功能
    initSubtaskManagement();
});

// 子任务管理功能
function initSubtaskManagement() {
    const saveSubtaskBtn = document.getElementById('saveSubtaskBtn');
    const subtaskForm = document.getElementById('subtaskForm');
    const addSubtaskModal = document.getElementById('addSubtaskModal');

    // 保存子任务
    if (saveSubtaskBtn) {
        saveSubtaskBtn.addEventListener('click', function() {
            const formData = new FormData(subtaskForm);
            const data = Object.fromEntries(formData.entries());

            // 验证必填字段
            if (!data.name || !data.responsible_person || !data.deadline) {
                alert('请填写所有必填字段');
                return;
            }

            // 发送创建请求
            fetch(`/tasks/{{ task.id }}/subtask/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(addSubtaskModal);
                    modal.hide();

                    // 重新加载页面以显示新子任务
                    location.reload();
                } else {
                    alert('创建子任务失败: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('创建子任务时发生错误');
            });
        });
    }

    // 子任务状态更新
    document.querySelectorAll('.subtask-status').forEach(select => {
        select.addEventListener('change', function() {
            const subtaskId = this.dataset.subtaskId;
            const newStatus = this.value;

            fetch(`/tasks/subtask/${subtaskId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 更新状态徽章
                    const subtaskItem = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
                    const badge = subtaskItem.querySelector('.badge');

                    // 更新徽章样式和文本
                    badge.className = 'badge ' + getStatusBadgeClass(newStatus);
                    badge.textContent = getStatusDisplayText(newStatus);

                    // 更新进度条
                    if (result.progress !== undefined) {
                        updateProgressBar(result.progress);
                    }

                    // 显示成功消息
                    showToast('子任务状态更新成功', 'success');
                } else {
                    alert('更新子任务状态失败: ' + result.error);
                    // 恢复原状态
                    this.value = this.dataset.originalValue;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新子任务状态时发生错误');
                // 恢复原状态
                this.value = this.dataset.originalValue;
            });
        });

        // 保存原始值
        select.dataset.originalValue = select.value;
    });

    // 删除子任务
    document.querySelectorAll('.delete-subtask').forEach(button => {
        button.addEventListener('click', function() {
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
            const subtaskName = subtaskItem.querySelector('h6').textContent;

            if (confirm(`确定要删除子任务"${subtaskName}"吗？此操作不可撤销。`)) {
                fetch(`/tasks/subtask/${subtaskId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // 移除子任务元素
                        subtaskItem.remove();

                        // 更新进度条
                        if (result.progress !== undefined) {
                            updateProgressBar(result.progress);
                        }

                        // 显示成功消息
                        showToast(result.message, 'success');

                        // 如果没有子任务了，显示空状态
                        const subtaskList = document.getElementById('subtask-list');
                        if (subtaskList && subtaskList.children.length === 0) {
                            location.reload();
                        }
                    } else {
                        alert('删除子任务失败: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除子任务时发生错误');
                });
            }
        });
    });
}

// 获取状态徽章样式
function getStatusBadgeClass(status) {
    switch(status) {
        case 'completed': return 'bg-success';
        case 'in_progress': return 'bg-warning';
        case 'pending': return 'bg-info';
        default: return 'bg-secondary';
    }
}

// 获取状态显示文本
function getStatusDisplayText(status) {
    switch(status) {
        case 'open': return '开放';
        case 'in_progress': return '进行中';
        case 'pending': return '待处理';
        case 'completed': return '已完成';
        default: return status;
    }
}

// 更新进度条
function updateProgressBar(progress) {
    const progressBar = document.querySelector('.progress-bar');
    const progressText = progressBar.querySelector('span');

    if (progressBar && progressText) {
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = progress + '%';

        // 更新进度条颜色
        progressBar.className = 'progress-bar ' + getProgressBarClass(progress);
    }
}

// 获取进度条样式
function getProgressBarClass(progress) {
    if (progress == 100) return 'bg-success';
    if (progress >= 75) return 'bg-info';
    if (progress >= 50) return 'bg-warning';
    return 'bg-danger';
}

// 显示提示消息
function showToast(message, type = 'info') {
    // 简单的提示实现，可以后续改为更美观的toast
    const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    // 3秒后自动消失
    setTimeout(() => {
        const alert = document.querySelector('.alert:last-child');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

// 标注显示功能（只读）
function initializeAnnotationDisplay() {
    console.log('Initializing annotation display (read-only)');
    // 这里只处理标注的显示，不包含编辑功能
}

// 注释：任务详情页面使用直接坐标，不需要缩放计算
// 这个方法已经验证工作正常

</script>
{% endblock %}
