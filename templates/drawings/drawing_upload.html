{% extends 'base.html' %}

{% block title %}上传图纸{% if project %} - {{ project.name }}{% endif %} - 建筑项目管理系统{% endblock %}

{% block content %}
<div class="container">
    {% if project %}
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'projects:project_list' %}">项目列表</a></li>
            <li class="breadcrumb-item"><a href="{% url 'projects:project_detail' project.pk %}">{{ project.name }}</a></li>
            <li class="breadcrumb-item active">上传图纸</li>
        </ol>
    </nav>
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-upload"></i> 上传图纸文件
                    </h4>
                    {% if project %}
                    <small class="text-muted">项目：{{ project.name }}</small>
                    {% endif %}
                </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="upload-form">
                    {% csrf_token %}

                    <!-- 图纸名称 -->
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            {{ form.name.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 文件上传区域 -->
                    <div class="mb-3">
                        <label class="form-label">
                            {{ form.file.label }} <span class="text-danger">*</span>
                        </label>

                        <div class="upload-area" id="upload-area">
                            <div id="upload-prompt">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p class="mb-2">拖拽图纸文件至此处或点击选择文件</p>
                                <p class="text-muted small">支持PDF、JPG、PNG、BMP、TIFF格式，文件大小不超过10MB</p>
                                {{ form.file }}
                            </div>

                            <div id="file-info" class="file-info" style="display: none;">
                                <i class="fas fa-file-pdf text-danger"></i>
                                <span id="file-name"></span>
                                <span id="file-size" class="text-muted"></span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="remove-file">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        {% if form.file.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.file.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 上传进度 -->
                    <div class="progress-container" id="progress-container">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%" id="upload-progress">
                                0%
                            </div>
                        </div>
                        <small class="text-muted mt-1">正在上传...</small>
                    </div>

                    <!-- 按钮 -->
                    <div class="d-flex justify-content-between mt-4">
                        {% if project %}
                        <a href="{% url 'projects:project_detail' project.pk %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回项目
                        </a>
                        {% else %}
                        <a href="{% url 'drawings:drawing_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回列表
                        </a>
                        {% endif %}
                        <button type="submit" class="btn btn-orange" id="submit-btn">
                            <i class="fas fa-upload"></i> 上传图纸
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('{{ form.file.id_for_label }}');
    const uploadPrompt = document.getElementById('upload-prompt');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    const progressContainer = document.getElementById('progress-container');
    const uploadProgress = document.getElementById('upload-progress');
    const submitBtn = document.getElementById('submit-btn');
    const nameInput = document.getElementById('{{ form.name.id_for_label }}');

    // 点击上传区域触发文件选择
    uploadArea.addEventListener('click', function(e) {
        if (e.target !== removeFileBtn && !removeFileBtn.contains(e.target)) {
            fileInput.click();
        }
    });

    // 文件选择处理
    fileInput.addEventListener('change', function(e) {
        handleFileSelect(e.target.files[0]);
    });

    // 拖拽处理
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    // 处理文件选择
    function handleFileSelect(file) {
        if (file) {
            // 验证文件类型
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/tiff'];
            if (!allowedTypes.includes(file.type)) {
                alert('支持的文件格式：PDF、JPEG、PNG、BMP、TIFF，请重新选择');
                return;
            }

            // 验证文件大小
            if (file.size > 10 * 1024 * 1024) {
                alert('文件大小不能超过10MB');
                return;
            }

            // 显示文件信息
            fileName.textContent = file.name;
            fileSize.textContent = `(${(file.size / (1024 * 1024)).toFixed(2)} MB)`;
            uploadPrompt.style.display = 'none';
            fileInfo.style.display = 'block';

            // 自动填充图纸名称（如果为空）
            if (!nameInput.value.trim()) {
                const baseName = file.name.replace(/\.pdf$/i, '');
                nameInput.value = baseName;
            }
        }
    }

    // 移除文件
    removeFileBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.value = '';
        uploadPrompt.style.display = 'block';
        fileInfo.style.display = 'none';
    });

    // 表单提交处理
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        if (!fileInput.files.length) {
            e.preventDefault();
            alert('请选择要上传的PDF文件');
            return;
        }

        if (!nameInput.value.trim()) {
            e.preventDefault();
            alert('请输入图纸名称');
            nameInput.focus();
            return;
        }

        // 显示进度条
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;

        // 模拟上传进度（实际项目中应该使用AJAX上传）
        let progress = 0;
        const interval = setInterval(function() {
            progress += Math.random() * 30;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
            }
            uploadProgress.style.width = progress + '%';
            uploadProgress.textContent = Math.round(progress) + '%';
        }, 200);
    });
});
</script>
{% endblock %}
