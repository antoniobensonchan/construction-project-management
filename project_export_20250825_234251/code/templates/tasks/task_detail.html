{% extends 'base.html' %}

{% block title %}{{ task.name }} - 任务详情{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-tasks"></i> {{ task.name }}
                    <span class="badge bg-secondary ms-2">{{ task.get_task_type_display }}</span>
                </h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">任务名称：</dt>
                    <dd class="col-sm-9">{{ task.name }}</dd>
                    
                    <dt class="col-sm-3">任务类型：</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-secondary">{{ task.get_task_type_display }}</span>
                    </dd>
                    
                    <dt class="col-sm-3">负责人：</dt>
                    <dd class="col-sm-9">{{ task.responsible_person }}</dd>
                    
                    <dt class="col-sm-3">截止时间：</dt>
                    <dd class="col-sm-9">
                        {{ task.deadline|date:"Y年m月d日" }}
                        {% if task.deadline < today %}
                            <span class="badge bg-danger ms-2">已逾期</span>
                        {% elif task.deadline == today %}
                            <span class="badge bg-warning ms-2">今日截止</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-3">创建时间：</dt>
                    <dd class="col-sm-9">{{ task.created_at|date:"Y-m-d H:i:s" }}</dd>
                    
                    <dt class="col-sm-3">更新时间：</dt>
                    <dd class="col-sm-9">{{ task.updated_at|date:"Y-m-d H:i:s" }}</dd>
                </dl>
            </div>
        </div>
        
        <!-- 关联图纸及标注 -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-pdf text-danger"></i> 关联图纸及标注
                </h5>
                {% if task.annotations.exists %}
                <span class="badge bg-primary">{{ task.annotations.count }} 个标注</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="mb-1">关联图纸 ({{ task.drawings.count }})</h6>
                        {% if task.drawings.exists %}
                            {% for drawing in task.drawings.all %}
                            <div class="mb-2">
                                <strong>{{ drawing.name }}</strong>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar"></i> 上传：{{ drawing.uploaded_at|date:"Y-m-d H:i" }} |
                                    <i class="fas fa-weight-hanging"></i> {{ drawing.file_size_mb }} MB |
                                    <i class="fas fa-file"></i> {{ drawing.page_count }} 页
                                </small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">无关联图纸</small>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-grid gap-2">
                            {% if task.drawings.exists %}
                                {% for drawing in task.drawings.all %}
                                <a href="{% url 'drawings:drawing_detail' drawing.pk %}"
                                   class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> 查看{{ drawing.name }}
                                </a>
                                {% endfor %}
                            {% endif %}
                            {% if task.annotations.exists %}
                            <button class="btn btn-success btn-sm" id="download-with-annotations">
                                <i class="fas fa-download"></i> 下载含标注图纸
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- PDF预览区域（含标注） -->
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>图纸预览</span>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info" id="toggle-annotations">
                                        <i class="fas fa-eye"></i> 显示/隐藏标注
                                    </button>
                                    <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-edit"></i> 编辑标注
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="pdf-container" style="height: 400px; overflow: auto; position: relative;">
                                <div id="pdf-loading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                    <p class="mt-2">正在加载图纸...</p>
                                </div>

                                <!-- 文件查看器和标注层 -->
                                <div id="file-viewer-wrapper" style="position: relative; display: none;">
                                    <!-- PDF查看器 -->
                                    {% if task.drawings.exists %}
                                    <embed id="pdf-viewer"
                                           src="{{ task.drawings.first.file.url }}"
                                           type="application/pdf"
                                           width="100%"
                                           height="400px"
                                           style="position: absolute; top: 0; left: 0; z-index: 1; display: none;">

                                    <!-- 图片查看器 -->
                                    <img id="image-viewer"
                                         src="{{ task.drawings.first.file.url }}"
                                         style="position: absolute; top: 0; left: 0; z-index: 1; max-width: 100%; max-height: 400px; object-fit: contain; display: none;"
                                         alt="{{ task.drawings.first.name }}">
                                    {% endif %}

                                    <!-- 标注层 -->
                                    <div id="annotation-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 400px; z-index: 2; pointer-events: none;">
                                        <!-- 标注将在这里显示 -->
                                    </div>
                                </div>

                                <div id="pdf-error" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                                    <h6>图纸加载失败</h6>
                                    <p class="text-muted small">请刷新页面重试</p>
                                </div>
                            </div>
                        </div>

                        <!-- 页码导航 -->
                        {% if task.drawings.exists and task.drawings.first.page_count > 1 %}
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" id="prev-page" disabled>
                                    <i class="fas fa-chevron-left"></i> 上一页
                                </button>

                                <div class="d-flex align-items-center gap-2">
                                    <span>第</span>
                                    <select class="form-select form-select-sm" id="page-select" style="width: auto;">
                                        {% load drawing_extras %}
                                        {% for page_num in task.drawings.first.page_count|range_from:1 %}
                                        <option value="{{ page_num }}" {% if page_num == 1 %}selected{% endif %}>{{ page_num }}</option>
                                        {% endfor %}
                                    </select>
                                    <span>页，共 {{ task.drawings.first.page_count }} 页</span>
                                </div>

                                <button class="btn btn-sm btn-outline-secondary" id="next-page" {% if task.drawing.page_count == 1 %}disabled{% endif %}>
                                    下一页 <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- 标注列表 -->
                {% if task.annotations.exists %}
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list"></i> 标注列表
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for annotation in task.annotations.all %}
                                <div class="col-md-6 mb-3">
                                    <div class="border rounded p-3">
                                        <div class="d-flex align-items-start">
                                            <div class="me-3">
                                                {% if annotation.is_point %}
                                                    <i class="fas fa-circle text-danger"></i>
                                                {% elif annotation.is_rectangle %}
                                                    <i class="fas fa-square text-danger"></i>
                                                {% elif annotation.is_text %}
                                                    <i class="fas fa-font text-danger"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ annotation.get_annotation_type_display }}</h6>
                                                <p class="mb-2 text-muted small">{{ annotation.content }}</p>
                                                <small class="text-muted">
                                                    第{{ annotation.page_number }}页
                                                    ({{ annotation.x_coordinate|floatformat:0 }}, {{ annotation.y_coordinate|floatformat:0 }})
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs"></i> 操作
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if task.drawings.exists %}
                        {% for drawing in task.drawings.all %}
                        <a href="{% url 'drawings:drawing_detail' drawing.pk %}"
                           class="btn btn-primary mb-2">
                            <i class="fas fa-eye"></i> 查看{{ drawing.name }}
                        </a>

                        <a href="{{ drawing.file.url }}"
                           class="btn btn-success mb-2"
                           download="{{ drawing.name }}.pdf">
                            <i class="fas fa-download"></i> 下载{{ drawing.name }}
                        </a>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            此任务没有关联图纸
                        </div>
                    {% endif %}
                    
                    <hr>
                    
                    {% if task.project %}
                    <a href="{% url 'projects:project_detail' task.project.pk %}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回项目
                    </a>
                    {% else %}
                    <a href="{% url 'tasks:task_list' %}"
                       class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回任务列表
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 任务统计信息 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar"></i> 任务信息
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary mb-1">
                                {% now "Y-m-d"|date:"Y-m-d" as today %}
                                {% if task.deadline >= today %}
                                    {{ task.deadline|timeuntil }}
                                {% else %}
                                    已逾期
                                {% endif %}
                            </h4>
                            <small class="text-muted">剩余时间</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info mb-1">{{ task.created_at|timesince }}</h4>
                        <small class="text-muted">创建时间</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfViewer = document.getElementById('pdf-viewer');
    const imageViewer = document.getElementById('image-viewer');
    const pdfLoading = document.getElementById('pdf-loading');
    const pdfError = document.getElementById('pdf-error');
    const annotationLayer = document.getElementById('annotation-layer');
    const toggleAnnotationsBtn = document.getElementById('toggle-annotations');
    const downloadBtn = document.getElementById('download-with-annotations');
    const fileViewerWrapper = document.getElementById('file-viewer-wrapper');

    let currentPage = 1;
    let totalPages = {% if task.drawings.exists %}{{ task.drawings.first.page_count }}{% else %}1{% endif %};
    let annotationsVisible = true;
    const fileType = "{% if task.drawings.exists %}{{ task.drawings.first.file_type }}{% else %}pdf{% endif %}";

    // 页码控制元素
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageSelect = document.getElementById('page-select');

    // 标注数据
    const annotations = [
        {% for annotation in task.annotations.all %}
        {
            type: '{{ annotation.annotation_type }}',
            page: {{ annotation.page_number }},
            x: {{ annotation.x_coordinate }},
            y: {{ annotation.y_coordinate }},
            {% if annotation.end_x %}end_x: {{ annotation.end_x }},{% endif %}
            {% if annotation.end_y %}end_y: {{ annotation.end_y }},{% endif %}
            {% if annotation.width %}width: {{ annotation.width }},{% endif %}
            {% if annotation.height %}height: {{ annotation.height }},{% endif %}
            color: '{{ annotation.color|default:"red" }}',
            content: '{{ annotation.content|escapejs }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('=== Task Detail Page Debug ===');
    console.log('Task ID: {{ task.id }}');
    console.log('Drawings count: {{ task.drawings.count }}');
    {% if task.drawings.exists %}
    console.log('First drawing file type: {{ task.drawings.first.file_type }}');
    {% endif %}
    console.log('Total annotations from database:', annotations.length);
    console.log('Annotations data:', annotations);
    console.log('================================');

    // 根据文件类型加载对应的查看器
    console.log('File type:', fileType);
    console.log('PDF Viewer:', pdfViewer);
    console.log('Image Viewer:', imageViewer);
    console.log('File Viewer Wrapper:', fileViewerWrapper);

    if (fileType === 'pdf') {
        // PDF文件处理
        console.log('Loading PDF file');
        if (pdfViewer && fileViewerWrapper) {
            pdfViewer.style.display = 'block';
            if (imageViewer) imageViewer.style.display = 'none';

            pdfViewer.addEventListener('load', function() {
                console.log('PDF loaded successfully');
                pdfLoading.style.display = 'none';
                fileViewerWrapper.style.display = 'block';
                renderAnnotations();
            });

            pdfViewer.addEventListener('error', function() {
                console.log('PDF load error');
                pdfLoading.style.display = 'none';
                pdfError.style.display = 'block';
            });
        }
    } else {
        // 图片文件处理
        console.log('Loading image file');
        if (imageViewer && fileViewerWrapper) {
            imageViewer.style.display = 'block';
            if (pdfViewer) pdfViewer.style.display = 'none';

            // 立即尝试加载图片
            console.log('Image src:', imageViewer.src);

            imageViewer.addEventListener('load', function() {
                console.log('Image loaded successfully');
                pdfLoading.style.display = 'none';
                fileViewerWrapper.style.display = 'block';
                renderAnnotations();
            });

            imageViewer.addEventListener('error', function() {
                console.log('Image load error');
                pdfLoading.style.display = 'none';
                pdfError.style.display = 'block';
            });

            // 强制触发加载检查
            setTimeout(() => {
                if (imageViewer.complete && imageViewer.naturalWidth > 0) {
                    console.log('Image already loaded, showing immediately');
                    pdfLoading.style.display = 'none';
                    fileViewerWrapper.style.display = 'block';
                    renderAnnotations();
                } else {
                    console.log('Image still loading...');
                }
            }, 1000);
        }
    }

    // 页码导航功能
    if (totalPages > 1 && prevPageBtn && nextPageBtn && pageSelect) {
        // 上一页
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updatePage();
            }
        });

        // 下一页
        nextPageBtn.addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePage();
            }
        });

        // 页码选择
        pageSelect.addEventListener('change', function() {
            currentPage = parseInt(this.value);
            updatePage();
        });

        // 更新页面显示
        function updatePage() {
            // 更新PDF显示
            const baseUrl = '{{ task.drawing.file.url }}';
            pdfViewer.src = `${baseUrl}#page=${currentPage}`;

            // 更新页码选择器
            pageSelect.value = currentPage;

            // 更新按钮状态
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;

            // 重新渲染当前页的标注
            renderAnnotations();
        }
    }

    // 渲染标注
    function renderAnnotations() {
        console.log('Rendering annotations...');
        console.log('Annotation layer:', annotationLayer);
        console.log('Annotations visible:', annotationsVisible);
        console.log('Current page:', currentPage);
        console.log('Total annotations:', annotations.length);

        if (!annotationLayer) {
            console.error('Annotation layer not found');
            return;
        }

        // 清除现有标注
        annotationLayer.innerHTML = '';

        if (!annotationsVisible) {
            console.log('Annotations hidden');
            return;
        }

        // 渲染当前页的标注
        const currentPageAnnotations = annotations.filter(a => a.page === currentPage);
        console.log('Current page annotations:', currentPageAnnotations);

        currentPageAnnotations.forEach((annotation, index) => {
            console.log(`Rendering annotation ${index}:`, annotation);
            let element;

            const color = annotation.color || 'red';
            const darkerColor = getDarkerColor(color);

            if (annotation.type === 'point') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x - 6}px;
                    top: ${annotation.y - 6}px;
                    width: 12px;
                    height: 12px;
                    background-color: ${color};
                    border: 2px solid ${darkerColor};
                    border-radius: 50%;
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;
                element.title = annotation.content;
                console.log('Created point element');
            } else if (annotation.type === 'line') {
                // 创建线条标记
                element = document.createElement('div');
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');

                const endX = annotation.end_x || annotation.x;
                const endY = annotation.end_y || annotation.y;
                const minX = Math.min(annotation.x, endX);
                const minY = Math.min(annotation.y, endY);
                const maxX = Math.max(annotation.x, endX);
                const maxY = Math.max(annotation.y, endY);
                const width = maxX - minX + 10;
                const height = maxY - minY + 10;

                element.style.cssText = `
                    position: absolute;
                    left: ${minX - 5}px;
                    top: ${minY - 5}px;
                    width: ${width}px;
                    height: ${height}px;
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;

                svg.style.cssText = `width: 100%; height: 100%;`;

                line.setAttribute('x1', annotation.x - minX + 5);
                line.setAttribute('y1', annotation.y - minY + 5);
                line.setAttribute('x2', endX - minX + 5);
                line.setAttribute('y2', endY - minY + 5);
                line.setAttribute('stroke', color);
                line.setAttribute('stroke-width', '3');
                line.setAttribute('stroke-linecap', 'round');

                svg.appendChild(line);
                element.appendChild(svg);
                element.title = annotation.content;
                console.log('Created line element');
            } else if (annotation.type === 'rectangle') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x}px;
                    top: ${annotation.y}px;
                    width: ${annotation.width}px;
                    height: ${annotation.height}px;
                    border: 2px solid red;
                    background: rgba(255, 0, 0, 0.1);
                    cursor: pointer;
                    pointer-events: auto;
                    z-index: 10;
                `;
                element.title = annotation.content;
                console.log('Created rectangle element');
            } else if (annotation.type === 'text') {
                element = document.createElement('div');
                element.style.cssText = `
                    position: absolute;
                    left: ${annotation.x}px;
                    top: ${annotation.y - 16}px;
                    color: red;
                    font-weight: bold;
                    font-size: 12px;
                    background: rgba(255,255,255,0.9);
                    padding: 2px 6px;
                    border-radius: 3px;
                    border: 1px solid red;
                    cursor: pointer;
                    pointer-events: auto;
                    max-width: 150px;
                    word-wrap: break-word;
                    z-index: 10;
                `;
                element.textContent = annotation.content;
                console.log('Created text element');
            }

            if (element) {
                annotationLayer.appendChild(element);
                console.log('Annotation element added to layer');
            }
        });

        console.log('Annotation rendering complete');
    }

    // 获取更深的颜色
    function getDarkerColor(color) {
        const colorMap = {
            'red': 'darkred',
            'blue': 'darkblue',
            'green': 'darkgreen',
            'yellow': 'orange',
            'orange': 'darkorange',
            'purple': 'darkviolet',
            'black': 'black'
        };
        return colorMap[color] || 'black';
    }

    // 切换标注显示
    if (toggleAnnotationsBtn) {
        toggleAnnotationsBtn.addEventListener('click', function() {
            annotationsVisible = !annotationsVisible;
            renderAnnotations();

            if (annotationsVisible) {
                this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏标注';
            } else {
                this.innerHTML = '<i class="fas fa-eye"></i> 显示标注';
            }
        });
    }

    // 下载含标注的PDF（模拟功能）
    if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
            // 这里应该调用后端API生成含标注的PDF
            // 目前先提供原PDF下载
            const link = document.createElement('a');
            link.href = '{{ task.drawing.file.url }}';
            link.download = '{{ task.drawing.name }}_含标注.pdf';
            link.click();

            // 显示提示
            alert('注意：当前下载的是原始PDF文件。含标注PDF生成功能将在后续版本中实现。');
        });
    }
});

// 标注显示功能（只读）
function initializeAnnotationDisplay() {
    console.log('Initializing annotation display (read-only)');
    // 这里只处理标注的显示，不包含编辑功能
}
</script>
{% endblock %}
