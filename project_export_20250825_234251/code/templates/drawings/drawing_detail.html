{% extends 'base.html' %}
{% load drawing_extras %}

{% block title %}{{ drawing.name }} - å›¾çº¸é¢„è§ˆ{% endblock %}

{% block content %}
<div class="row">
    <!-- PDFé¢„è§ˆåŒºåŸŸ (70%å®½åº¦) -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-pdf text-danger"></i> {{ drawing.name }}
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="zoom-out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="zoom-reset">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="zoom-in">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="pdf-container" style="height: 600px; overflow: auto; position: relative;">
                    <div id="pdf-loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨åŠ è½½å›¾çº¸ï¼ˆ<span id="current-page">1</span>/{{ drawing.page_count }} é¡µï¼‰</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" id="refresh-pdf" style="display: none;">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°
                        </button>
                    </div>
                    <!-- PDFæŸ¥çœ‹å™¨ -->
                    <embed id="pdf-viewer"
                           src="{{ drawing.file.url }}"
                           type="application/pdf"
                           width="100%"
                           height="100%"
                           style="display: none;">

                    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
                    <img id="image-viewer"
                         src="{{ drawing.file.url }}"
                         style="position: absolute; top: 0; left: 0; max-width: 100%; max-height: 600px; object-fit: contain; display: none;"
                         alt="{{ drawing.name }}">

                    <!-- æ ‡æ³¨å±‚ -->
                    <div id="annotation-layer"
                         style="position: absolute; top: 0; left: 0; width: 100%; height: 600px; z-index: 10; pointer-events: none;">
                        <!-- æ ‡æ³¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>

                    <div id="pdf-error" class="text-center py-5" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5>æ–‡ä»¶åŠ è½½å¤±è´¥</h5>
                        <p class="text-muted">è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–ä¸‹è½½æ–‡ä»¶æœ¬åœ°æŸ¥çœ‹</p>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-primary" id="retry-load">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°é¡µé¢
                            </button>
                            <a href="{{ drawing.file.url }}" class="btn btn-success" download>
                                <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                            </a>
                        </div>
                    </div>
                </div>

                <!-- é¡µç å¯¼èˆª -->
                {% if drawing.page_count > 1 %}
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-sm btn-outline-secondary" id="prev-page" disabled>
                            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                        </button>

                        <div class="d-flex align-items-center gap-2">
                            <span>ç¬¬</span>
                            <select class="form-select form-select-sm" id="page-select" style="width: auto;">
                                {% for page_num in drawing.page_count|range_from:1 %}
                                <option value="{{ page_num }}" {% if page_num == 1 %}selected{% endif %}>{{ page_num }}</option>
                                {% endfor %}
                            </select>
                            <span>é¡µï¼Œå…± {{ drawing.page_count }} é¡µ</span>
                        </div>

                        <button class="btn btn-sm btn-outline-secondary" id="next-page" {% if drawing.page_count == 1 %}disabled{% endif %}>
                            ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- å›¾çº¸ä¿¡æ¯æ  (30%å®½åº¦) -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> å›¾çº¸ä¿¡æ¯
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">æ–‡ä»¶åï¼š</dt>
                    <dd class="col-sm-8">{{ drawing.name }}</dd>
                    
                    <dt class="col-sm-4">æ–‡ä»¶å¤§å°ï¼š</dt>
                    <dd class="col-sm-8">{{ drawing.file_size_mb }} MB</dd>
                    
                    <dt class="col-sm-4">ä¸Šä¼ æ—¶é—´ï¼š</dt>
                    <dd class="col-sm-8">{{ drawing.uploaded_at|date:"Y-m-d H:i:s" }}</dd>
                    
                    <dt class="col-sm-4">æ›´æ–°æ—¶é—´ï¼š</dt>
                    <dd class="col-sm-8">{{ drawing.updated_at|date:"Y-m-d H:i:s" }}</dd>
                </dl>
                
                <hr>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="d-grid gap-2">
                    <a href="{% url 'tasks:task_create' %}?drawing_id={{ drawing.id }}" 
                       class="btn btn-orange">
                        <i class="fas fa-plus"></i> åŸºäºæ­¤å›¾çº¸åˆ›å»ºä»»åŠ¡
                    </a>
                    
                    <a href="{{ drawing.file.url }}" 
                       class="btn btn-success" 
                       download="{{ drawing.name }}.pdf">
                        <i class="fas fa-download"></i> ä¸‹è½½PDFæ–‡ä»¶
                    </a>
                    
                    {% if drawing.project %}
                    <a href="{% url 'projects:project_detail' drawing.project.pk %}"
                       class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¡¹ç›®
                    </a>
                    {% else %}
                    <a href="{% url 'drawings:drawing_list' %}"
                       class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'drawings:drawing_delete' drawing.pk %}" 
                       class="btn btn-danger">
                        <i class="fas fa-trash"></i> åˆ é™¤å›¾çº¸
                    </a>
                </div>
            </div>
        </div>
        
        <!-- å…³è”ä»»åŠ¡ -->
        {% if related_tasks.exists %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tasks"></i> å…³è”ä»»åŠ¡ ({{ related_tasks.count }})
                </h6>
            </div>
            <div class="card-body">
                {% for task in related_tasks %}
                <div class="border-bottom pb-3 mb-3 task-item"
                     data-task-id="{{ task.pk }}"
                     onmouseover="highlightTaskAnnotations({{ task.pk }})"
                     onmouseout="unhighlightAllAnnotations()">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ task.name }}</h6>
                            <small class="text-muted">
                                <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in_progress' %}warning{% elif task.status == 'pending' %}secondary{% else %}danger{% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                                <span class="badge bg-info">{{ task.get_task_type_display }}</span>
                                <br>è´Ÿè´£äººï¼š{{ task.responsible_person }}
                                <br>æˆªæ­¢ï¼š{{ task.deadline|date:"Y-m-d" }}
                                {% if task.project %}
                                <br>é¡¹ç›®ï¼š{{ task.project.name }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-2">
                            <a href="{% url 'tasks:task_detail' task.pk %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-eye"></i> æŸ¥çœ‹
                            </a>
                            <a href="{% url 'tasks:task_update' task.pk %}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-edit"></i> ç¼–è¾‘
                            </a>
                            <a href="{% url 'tasks:task_delete' task.pk %}" class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('ç¡®è®¤åˆ é™¤ä»»åŠ¡ã€Œ{{ task.name }}ã€ï¼Ÿ')">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfViewer = document.getElementById('pdf-viewer');
    const imageViewer = document.getElementById('image-viewer');
    const pdfLoading = document.getElementById('pdf-loading');
    const pdfError = document.getElementById('pdf-error');
    const pdfContainer = document.getElementById('pdf-container');
    const refreshBtn = document.getElementById('refresh-pdf');
    const retryBtn = document.getElementById('retry-load');

    let currentZoom = 1;
    let totalPages = {{ drawing.page_count }};
    let loadRetryCount = 0;
    const maxRetries = 2;
    const fileType = "{{ drawing.file_type }}";

    // é¡µç æ§åˆ¶å…ƒç´ 
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageSelect = document.getElementById('page-select');

    // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„æŸ¥çœ‹å™¨
    if (fileType === 'pdf') {
        // PDFæ–‡ä»¶å¤„ç†
        pdfViewer.addEventListener('load', function() {
            pdfLoading.style.display = 'none';
            pdfViewer.style.display = 'block';
            loadRetryCount = 0;
        });

        pdfViewer.addEventListener('error', function() {
            handleLoadError();
        });
    } else {
        // å›¾ç‰‡æ–‡ä»¶å¤„ç†
        imageViewer.addEventListener('load', function() {
            pdfLoading.style.display = 'none';
            imageViewer.style.display = 'block';
            loadRetryCount = 0;

            // å›¾ç‰‡åŠ è½½å®Œæˆåæ¸²æŸ“æ ‡æ³¨
            console.log('ğŸ“· Image loaded, initializing annotations...');
            setTimeout(() => {
                if (typeof initializeAnnotations === 'function') {
                    initializeAnnotations();
                } else {
                    console.error('âŒ initializeAnnotations function not found');
                }
            }, 500);
        });

        imageViewer.addEventListener('error', function() {
            handleLoadError();
        });
    }

    // å¤„ç†åŠ è½½é”™è¯¯
    function handleLoadError() {
        if (loadRetryCount < maxRetries) {
            loadRetryCount++;
            refreshBtn.style.display = 'inline-block';
            setTimeout(() => {
                reloadPdf();
            }, 1000);
        } else {
            pdfLoading.style.display = 'none';
            pdfError.style.display = 'block';
        }
    }

    // é‡æ–°åŠ è½½PDF
    function reloadPdf() {
        pdfViewer.src = pdfViewer.src + '?t=' + new Date().getTime();
        refreshBtn.style.display = 'none';
    }

    // åˆ·æ–°æŒ‰é’®äº‹ä»¶
    refreshBtn.addEventListener('click', reloadPdf);
    retryBtn.addEventListener('click', () => location.reload());

    // é¡µç å¯¼èˆªåŠŸèƒ½
    if (totalPages > 1) {
        // ä¸Šä¸€é¡µ
        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updatePage();
            }
        });

        // ä¸‹ä¸€é¡µ
        nextPageBtn.addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                updatePage();
            }
        });

        // é¡µç é€‰æ‹©
        pageSelect.addEventListener('change', function() {
            currentPage = parseInt(this.value);
            updatePage();
        });

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        function updatePage() {
            // æ›´æ–°PDFæ˜¾ç¤ºï¼ˆé€šè¿‡URLå‚æ•°æŒ‡å®šé¡µç ï¼‰
            const baseUrl = '{{ drawing.file.url }}';
            pdfViewer.src = `${baseUrl}#page=${currentPage}`;

            // æ›´æ–°é¡µç é€‰æ‹©å™¨
            pageSelect.value = currentPage;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;

            // æ›´æ–°åŠ è½½æç¤ºä¸­çš„é¡µç 
            document.getElementById('current-page').textContent = currentPage;

            // é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢çš„æ ‡æ³¨
            setTimeout(renderAnnotations, 500);
        }
    }

    // ç¼©æ”¾æ§åˆ¶
    document.getElementById('zoom-in').addEventListener('click', function() {
        if (currentZoom < 2) {
            currentZoom += 0.25;
            updateZoom();
        }
    });

    document.getElementById('zoom-out').addEventListener('click', function() {
        if (currentZoom > 0.5) {
            currentZoom -= 0.25;
            updateZoom();
        }
    });

    document.getElementById('zoom-reset').addEventListener('click', function() {
        currentZoom = 1;
        updateZoom();
    });

    function updateZoom() {
        pdfViewer.style.transform = `scale(${currentZoom})`;
        pdfViewer.style.transformOrigin = 'top left';

        // è°ƒæ•´å®¹å™¨é«˜åº¦ä»¥é€‚åº”ç¼©æ”¾
        const newHeight = 600 * currentZoom;
        pdfContainer.style.height = Math.max(600, newHeight) + 'px';
    }

    // é¼ æ ‡æ»šè½®ç¼©æ”¾ï¼ˆæŒ‰ä½Ctrlé”®ï¼‰
    pdfContainer.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
            if (e.deltaY < 0 && currentZoom < 2) {
                currentZoom += 0.1;
                updateZoom();
            } else if (e.deltaY > 0 && currentZoom > 0.5) {
                currentZoom -= 0.1;
                updateZoom();
            }
        }
    });

    // é”®ç›˜å¯¼èˆª
    document.addEventListener('keydown', function(e) {
        if (totalPages > 1) {
            if (e.key === 'ArrowLeft' && currentPage > 1) {
                currentPage--;
                updatePage();
            } else if (e.key === 'ArrowRight' && currentPage < totalPages) {
                currentPage++;
                updatePage();
            }
        }
    });

});

// å…¨å±€å˜é‡
let currentPage = 1;

// æ ‡æ³¨æ•°æ®
const allAnnotations = [
    {% for annotation in all_annotations %}
    {
        id: {{ annotation.id }},
        type: '{{ annotation.annotation_type }}',
        page: {{ annotation.page_number }},
        x: {{ annotation.x_coordinate }},
        y: {{ annotation.y_coordinate }},
        {% if annotation.end_x %}end_x: {{ annotation.end_x }},{% endif %}
        {% if annotation.end_y %}end_y: {{ annotation.end_y }},{% endif %}
        color: '{{ annotation.color|default:"red" }}',
        content: '{{ annotation.content|escapejs }}',
        taskName: '{{ annotation.task.name|escapejs }}',
        taskId: {{ annotation.task.id }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// è°ƒè¯•ï¼šè¾“å‡ºæ ‡æ³¨æ•°æ®
console.log('ğŸ¯ Loaded annotations data:', allAnnotations);

// åˆå§‹åŒ–æ ‡æ³¨æ˜¾ç¤º
function initializeAnnotations() {
    console.log('ğŸ¯ Initializing annotations display for drawing');
    console.log('ğŸ“Š Total annotations:', allAnnotations.length);

    // ç«‹å³æ¸²æŸ“æ ‡æ³¨
    renderAnnotations();
}

// æ¸²æŸ“æ‰€æœ‰æ ‡æ³¨
function renderAnnotations() {
    const annotationLayer = document.getElementById('annotation-layer');
    if (!annotationLayer) {
        console.log('âŒ Annotation layer not found');
        return;
    }

    console.log('ğŸ¯ Starting to render annotations...');
    console.log('ğŸ“Š Total annotations:', allAnnotations.length);
    console.log('ğŸ“„ Current page:', currentPage);

    // æ¸…é™¤ç°æœ‰æ ‡æ³¨
    annotationLayer.innerHTML = '';

    let renderedCount = 0;
    allAnnotations.forEach((annotation, index) => {
        if (annotation.page === currentPage) {
            console.log(`ğŸ¨ Rendering annotation ${index}:`, annotation);
            renderAnnotation(annotation, annotationLayer, index);
            renderedCount++;
        }
    });

    console.log(`âœ… Rendered ${renderedCount} annotations for page ${currentPage}`);
    console.log('ğŸ“ Annotation layer style:', annotationLayer.style.cssText);
}

// æ¸²æŸ“å•ä¸ªæ ‡æ³¨
function renderAnnotation(annotation, container, index) {
    const color = annotation.color || 'red';
    let element;

    if (annotation.type === 'point') {
        element = document.createElement('div');
        element.style.cssText = `
            position: absolute;
            left: ${annotation.x - 8}px;
            top: ${annotation.y - 8}px;
            width: 16px;
            height: 16px;
            background-color: ${color};
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        `;
        element.title = `${annotation.taskName}: ${annotation.content}`;
    } else if (annotation.type === 'text') {
        element = document.createElement('div');
        element.style.cssText = `
            position: absolute;
            left: ${annotation.x}px;
            top: ${annotation.y}px;
            background-color: ${color};
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            max-width: 200px;
            word-wrap: break-word;
        `;
        element.textContent = annotation.content;
        element.title = `ä»»åŠ¡: ${annotation.taskName}`;
    } else if (annotation.type === 'line' && annotation.end_x && annotation.end_y) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');

        const minX = Math.min(annotation.x, annotation.end_x);
        const minY = Math.min(annotation.y, annotation.end_y);
        const width = Math.abs(annotation.end_x - annotation.x) + 10;
        const height = Math.abs(annotation.end_y - annotation.y) + 10;

        element = document.createElement('div');
        element.style.cssText = `
            position: absolute;
            left: ${minX - 5}px;
            top: ${minY - 5}px;
            width: ${width}px;
            height: ${height}px;
            cursor: pointer;
            z-index: 10;
        `;

        svg.style.cssText = `width: 100%; height: 100%;`;

        line.setAttribute('x1', annotation.x - minX + 5);
        line.setAttribute('y1', annotation.y - minY + 5);
        line.setAttribute('x2', annotation.end_x - minX + 5);
        line.setAttribute('y2', annotation.end_y - minY + 5);
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', '3');
        line.setAttribute('stroke-linecap', 'round');

        svg.appendChild(line);
        element.appendChild(svg);
        element.title = `${annotation.taskName}: ${annotation.content}`;
    }

    if (element) {
        // æ·»åŠ æ ‡è¯†å±æ€§
        element.setAttribute('data-annotation-id', annotation.id);
        element.setAttribute('data-task-id', annotation.taskId);
        element.setAttribute('data-annotation-index', index);

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°ç›¸å…³ä»»åŠ¡
        element.addEventListener('click', function() {
            if (confirm(`æŸ¥çœ‹ä»»åŠ¡ã€Œ${annotation.taskName}ã€ï¼Ÿ`)) {
                window.open(`/tasks/${annotation.taskId}/`, '_blank');
            }
        });

        container.appendChild(element);
        console.log(`âœ… Added ${annotation.type} annotation at (${annotation.x}, ${annotation.y}) with color ${color}`);
    } else {
        console.log(`âŒ Failed to create element for annotation:`, annotation);
    }
}

// é«˜äº®æŒ‡å®šä»»åŠ¡çš„æ ‡æ³¨
function highlightTaskAnnotations(taskId) {
    console.log('Highlighting annotations for task:', taskId);

    // é‡ç½®æ‰€æœ‰æ ‡æ³¨çš„æ ·å¼
    const allAnnotationElements = document.querySelectorAll('#annotation-layer [data-task-id]');
    allAnnotationElements.forEach(element => {
        element.style.opacity = '0.3';
        element.style.transform = 'scale(1)';
        element.style.transition = 'all 0.3s ease';
        element.style.boxShadow = '';
        element.style.zIndex = '10';
    });

    // é«˜äº®æŒ‡å®šä»»åŠ¡çš„æ ‡æ³¨
    const taskAnnotationElements = document.querySelectorAll(`#annotation-layer [data-task-id="${taskId}"]`);
    taskAnnotationElements.forEach(element => {
        element.style.opacity = '1';
        element.style.transform = 'scale(1.2)';
        element.style.transition = 'all 0.3s ease';
        element.style.boxShadow = '0 0 15px rgba(255, 255, 0, 0.8)';
        element.style.zIndex = '20';
    });

    // é«˜äº®ä»»åŠ¡é¡¹
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        if (parseInt(item.dataset.taskId) === taskId) {
            item.style.backgroundColor = '#fff3cd';
            item.style.border = '2px solid #ffc107';
            item.style.borderRadius = '5px';
            item.style.transition = 'all 0.3s ease';
        } else {
            item.style.backgroundColor = '';
            item.style.border = '';
            item.style.borderRadius = '';
        }
    });

    console.log(`Highlighted ${taskAnnotationElements.length} annotations for task ${taskId}`);
}

// å–æ¶ˆé«˜äº®æ‰€æœ‰æ ‡æ³¨
function unhighlightAllAnnotations() {
    console.log('Unhighlighting all annotations');

    // æ¢å¤æ‰€æœ‰æ ‡æ³¨çš„æ ·å¼
    const allAnnotationElements = document.querySelectorAll('#annotation-layer > *');
    allAnnotationElements.forEach(element => {
        element.style.opacity = '1';
        element.style.transform = 'scale(1)';
        element.style.transition = 'all 0.3s ease';
        element.style.boxShadow = '';
        element.style.zIndex = '10';
    });

    // æ¢å¤ä»»åŠ¡é¡¹æ ·å¼
    const taskItems = document.querySelectorAll('.task-item');
    taskItems.forEach(item => {
        item.style.backgroundColor = '';
        item.style.border = '';
        item.style.borderRadius = '';
    });
}
</script>
{% endblock %}
