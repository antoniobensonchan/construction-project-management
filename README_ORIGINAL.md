# 建筑项目管理系统 (POC版本 - 补充功能版)

## 项目概述

这是一个专注于"PDF图纸上传+任务关联+标注功能"的建筑项目管理系统POC版本。系统不仅实现了从图纸上传到任务创建的完整闭环流程，还新增了PDF兼容性优化和轻量化标注工具，为建筑施工场景提供精确的位置标记能力。

## 核心功能

### ✅ 已实现功能

1. **PDF图纸管理（增强版）**
   - PDF文件上传（支持拖拽上传）
   - 文件大小验证（≤10MB）
   - 文件格式验证（仅支持PDF）
   - **PDF兼容性检测**（支持PDF 1.5-1.7版本）
   - **文件完整性验证**（自动检测损坏文件）
   - **多页PDF支持**（页码导航、页面切换）
   - **智能缩略图生成**（16:9比例，自动裁剪）
   - 图纸列表展示（按上传时间倒序）
   - PDF图纸预览（支持放大/缩小、拖动查看、键盘导航）
   - 图纸删除功能（带确认弹窗）

2. **任务管理（增强版）**
   - 两步骤任务创建流程
     - 步骤1：填写任务信息（名称、类型、负责人、截止时间）
     - 步骤2：关联图纸选择 + **实时PDF预览**
   - **轻量化标注工具**
     - 点标记：精确位置标记（如预埋件位置）
     - 矩形标记：区域范围标记（如浇筑区域）
     - 文字标注：文字说明标记（如施工要求）
   - **标注管理功能**
     - 标注列表查看
     - 单个标注删除
     - 批量清空标注
     - 标注数量限制（最多10个）
   - 任务列表展示（按截止时间倒序）
   - **任务详情页面**（显示任务信息和关联标注）
   - 任务-图纸关联查看

3. **标注功能**
   - **任务创建时标注**：在选择图纸后可直接在PDF上添加标注
   - **标注数据存储**：标注与任务绑定，支持多种标注类型
   - **标注可视化显示**：任务详情页面显示所有标注
   - **标注交互功能**：hover查看备注、点击编辑、批量管理
   - **含标注PDF下载**（基础版本，后续可扩展）

4. **核心闭环（增强版）**
   - 上传PDF图纸 → 创建关联任务 → 添加位置标注 → 查看任务列表 → 查看任务详情和标注
   - 完整的"图纸-任务-位置"三者关联逻辑

## 技术栈

- **后端**: Django 4.2.7
- **前端**: Bootstrap 5.1.3 + 自定义CSS/JavaScript
- **数据库**: SQLite（开发环境）
- **文件处理**: Pillow, PyPDF2, pdf2image
- **PDF处理**: PyPDF2 3.0.1（PDF解析和验证）
- **图像处理**: pdf2image 1.16.3（缩略图生成）
- **其他**: Font Awesome 6.0、CORS支持

## 安装和运行

### 环境要求

- Python 3.8+
- Windows 10/11 或 macOS 12+
- Chrome 浏览器 100+

### 安装步骤

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd ConstructionPMProject
   ```

2. **创建虚拟环境**
   ```bash
   python -m venv venv
   ```

3. **激活虚拟环境**
   ```bash
   # Windows
   venv\Scripts\activate
   
   # macOS/Linux
   source venv/bin/activate
   ```

4. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

5. **数据库迁移**
   ```bash
   python manage.py makemigrations
   python manage.py migrate
   ```

6. **启动开发服务器**
   ```bash
   python manage.py runserver
   ```

7. **访问系统**
   打开浏览器访问：http://127.0.0.1:8000/

## 使用指南

### 1. 上传PDF图纸

1. 点击首页的"上传图纸"按钮
2. 输入图纸名称（如"3层东墙钢筋绑扎图"）
3. 选择或拖拽PDF文件（≤10MB）
4. 点击"上传图纸"完成上传

### 2. 查看图纸

1. 在图纸列表中点击图纸卡片
2. 进入图纸预览页面
3. 支持放大/缩小、拖动查看
4. 可下载原始PDF文件

### 3. 创建任务（含标注功能）

**方式一：从任务管理入口**
1. 点击导航栏"任务管理"
2. 点击"新建任务"按钮

**方式二：从图纸预览页面**
1. 在图纸预览页面点击"基于此图纸创建任务"

**创建流程：**
1. **步骤1**：填写任务信息
   - 任务名称（必填）
   - 任务类型（新建施工/整改修复/检查验收）
   - 负责人（必填）
   - 截止时间（必填，不可选过去日期）

2. **步骤2**：选择关联图纸 + 添加标注
   - 从已上传的图纸中选择一张
   - **实时预览**：选中图纸后自动显示PDF预览
   - **添加标注**：使用标注工具在图纸上标记位置
     - 点标记：点击图纸添加精确位置标记
     - 矩形标记：拖拽绘制区域范围标记
     - 文字标注：点击添加文字说明
   - **标注管理**：查看标注列表、删除单个标注、清空所有标注
   - 点击"完成创建"（自动保存标注数据）

### 4. 查看任务（含标注显示）

1. 在任务列表中查看所有任务
2. 点击"任务详情"查看详细信息
3. **任务详情页面功能**：
   - 查看任务基本信息
   - **图纸预览**：直接在页面中预览关联图纸
   - **标注显示**：自动显示任务创建时添加的所有标注
   - **标注交互**：hover查看标注备注、切换显示/隐藏
   - **多页导航**：支持多页PDF的页面切换
   - **下载功能**：下载原始PDF或含标注PDF
4. 点击"查看原图纸"跳转到图纸详情页面

## 系统测试

运行自动化测试脚本验证系统功能：

```bash
python test_system.py
```

测试覆盖：
- ✅ 图纸上传功能
- ✅ 图纸列表显示
- ✅ 图纸预览功能
- ✅ 任务创建功能
- ✅ 任务列表显示
- ✅ 任务详情页面
- ✅ 任务-图纸关联跳转
- ✅ 核心流程闭环

## POC验收标准

### ✅ 图纸上传验收
- **条件**: 使用Chrome浏览器，上传1个5MB的PDF施工图纸
- **结果**: ✅ 上传进度条正常显示，上传完成后弹窗提示正确，图纸成功显示在"图纸列表"，点击可跳转至预览页，支持放大至200%、拖动查看

### ✅ 任务创建与关联验收
- **条件**: 填写所有必填任务信息，选择已上传的图纸，点击"完成创建"
- **结果**: ✅ 任务成功显示在"任务列表"，顶部提示条正确显示，点击"关联图纸"标签可跳转至对应图纸预览页，任务信息与图纸关联无错误

### ✅ 核心流程闭环验收
- **条件**: 按"上传PDF图纸→创建关联任务→查看任务列表→点击关联图纸标签查看图纸"的顺序操作
- **结果**: ✅ 全流程无卡顿、无报错，每个环节跳转正确，达成"图纸-任务"关联查询的核心目标

## 项目结构

```
ConstructionPMProject/
├── construction_pm/          # Django项目配置
├── drawings/                 # 图纸管理应用
│   ├── models.py            # 图纸数据模型
│   ├── views.py             # 图纸视图逻辑
│   ├── forms.py             # 图纸表单
│   └── urls.py              # 图纸URL配置
├── tasks/                    # 任务管理应用
│   ├── models.py            # 任务数据模型
│   ├── views.py             # 任务视图逻辑
│   ├── forms.py             # 任务表单
│   └── urls.py              # 任务URL配置
├── templates/                # HTML模板
│   ├── base.html            # 基础模板
│   ├── drawings/            # 图纸相关模板
│   └── tasks/               # 任务相关模板
├── static/                   # 静态文件
│   ├── css/                 # 自定义样式
│   └── js/                  # 自定义脚本
├── media/                    # 用户上传文件
├── test_system.py           # 系统测试脚本
├── requirements.txt         # 项目依赖
└── README.md               # 项目说明
```

## 后续开发计划

POC版本验证了核心功能的可行性，后续正式版可考虑：

1. **功能扩展**
   - 多图纸关联任务
   - 图纸标注和批注
   - 任务状态管理
   - 用户权限系统

2. **性能优化**
   - 大文件上传优化
   - 图纸缓存机制
   - 数据库查询优化

3. **系统集成**
   - 人员管理系统对接
   - 施工进度系统集成
   - 移动端支持

## 联系信息

如有问题或建议，请联系开发团队。
