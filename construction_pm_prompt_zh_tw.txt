# 建築項目管理系統 - 詳細開發提示 (繁體中文)

## 系統概述
請使用 Django 4.2.7 創建一個專業的建築項目管理系統，專注於「PDF圖紙上傳+任務關聯+標註功能」的完整閉環流程。系統採用現代化的三層架構：用戶 → 項目 → 工地 → 任務/圖紙，支持多用戶、多項目、多工地的複雜建築場景管理。

## 核心數據模型設計

### 1. 用戶認證系統 (accounts app)
- 擴展 Django AbstractUser 創建自定義用戶模型
- 字段：username, email, company_name(公司名稱), phone(聯繫電話), created_at, updated_at
- 實現完整的登錄/註冊/登出功能
- 支持用戶資料管理和權限控制

### 2. 項目管理系統 (projects app)
**Project 模型：**
- 字段：owner(外鍵到User), name(項目名稱), description(項目描述), start_date(開始日期), end_date(結束日期)
- status 選擇：planning(規劃中), active(進行中), completed(已完成), suspended(暫停), cancelled(已取消)
- 方法：duration_days(項目天數), progress_percentage(進度百分比), clean(數據驗證)

**WorkSite 模型：**
- 字段：project(外鍵到Project), name(工地名稱), description(工地描述), location(工地地址)
- site_manager(工地負責人), contact_phone(聯繫電話)
- status 選擇：preparing(準備中), active(施工中), completed(已完成), suspended(暫停)
- 統計方法：task_count(任務數量), drawing_count(圖紙數量)

### 3. 圖紙管理系統 (drawings app)
**Drawing 模型：**
- 字段：worksite(外鍵到WorkSite), name(圖紙名稱), file(文件字段)
- 支持格式：PDF, JPG, JPEG, PNG, BMP, TIFF
- 自動字段：file_size_mb(文件大小), page_count(頁數), uploaded_at(上傳時間)
- 驗證功能：PDF兼容性檢測(支持PDF 1.5-1.7版本), 文件完整性驗證, 文件大小限制(≤10MB)
- 縮略圖生成：智能16:9比例縮略圖，自動裁剪
- 方法：validate_pdf(), validate_image(), generate_thumbnail()

### 4. 任務管理系統 (tasks app)
**Task 模型：**
- 字段：worksite(外鍵到WorkSite), parent_task(自關聯，支持子任務), name(任務名稱), description(任務描述)
- task_type 選擇：new_construction(新建施工), repair(整改修復), inspection(檢查驗收), maintenance(維護保養)
- status 選擇：pending(待開始), in_progress(進行中), completed(已完成), cancelled(已取消)
- responsible_person(負責人), deadline(截止時間)
- 屬性方法：project(通過工地間接關聯項目)

**TaskAnnotation 模型：**
- 字段：task(外鍵到Task), drawing(外鍵到Drawing), annotation_type, page_number(頁碼)
- 坐標字段：x_coordinate, y_coordinate, width, height, end_x, end_y
- annotation_type 選擇：point(點標記), rectangle(矩形標記), text(文字標註), line(線條標註)
- color 選擇：red(紅色), blue(藍色), green(綠色), yellow(黃色), orange(橙色), purple(紫色), black(黑色)
- content(標註內容), created_at(創建時間)

## 前端界面設計要求

### 1. 技術棧
- Bootstrap 5.1.3 響應式框架
- Font Awesome 6.0 圖標庫
- 自定義 CSS 動畫效果
- 原生 JavaScript (無需 jQuery)
- 支持拖拽上傳功能

### 2. 頁面佈局
**基礎模板 (base.html)：**
- 響應式導航欄：項目管理、任務管理、圖紙管理、用戶中心
- 麵包屑導航
- 消息提示系統 (Django messages)
- 統一的頁腳設計

**項目列表頁面：**
- 卡片式佈局展示所有項目
- 每個項目卡片顯示：項目名稱、狀態、進度條、工地數量、任務數量、圖紙數量
- 支持項目狀態篩選和搜索功能
- 創建新項目按鈕

**項目詳情頁面：**
- 標籤頁設計：項目概覽、工地管理、圖紙匯總、任務匯總
- 工地管理：顯示所有工地，支持創建、編輯、刪除工地
- 圖紙匯總：顯示所有工地的圖紙匯總，但不允許在項目級別直接上傳圖紙
- 任務匯總：顯示所有工地的任務匯總，但不允許在項目級別直接創建任務

**工地詳情頁面：**
- 工地基本信息展示
- 工地圖紙管理：上傳圖紙、圖紙列表、圖紙預覽
- 工地任務管理：創建任務、任務列表、任務狀態統計
- 工地統計圖表：任務完成率、圖紙數量統計

### 3. 圖紙功能界面
**圖紙上傳頁面：**
- 拖拽上傳區域，支持點擊選擇文件
- 實時文件驗證：格式檢查、大小檢查、完整性檢查
- 上傳進度條顯示
- 圖紙名稱輸入框
- 上傳成功後自動跳轉到圖紙列表

**圖紙列表頁面：**
- 網格佈局顯示圖紙縮略圖
- 每個圖紙卡片顯示：縮略圖、圖紙名稱、文件大小、上傳時間、頁數
- 支持按工地篩選、按上傳時間排序
- 圖紙操作：查看詳情、下載、刪除

**圖紙詳情頁面：**
- PDF/圖片預覽器：支持放大/縮小、拖動查看、鍵盤導航
- 多頁PDF支持：頁碼導航、頁面切換
- 圖紙信息面板：文件名、所屬工地、所屬項目、文件大小、上傳時間
- 關聯任務顯示：顯示使用此圖紙的所有任務
- 標註顯示：顯示圖紙上的所有標註，支持按任務篩選

### 4. 任務功能界面
**任務創建頁面：**
- 分步驟表單設計
- 步驟1：基本信息 - 任務名稱、類型、負責人、截止時間、描述
- 步驟2：圖紙關聯 - 從工地圖紙中選擇，實時預覽
- 步驟3：標註添加 - 在選中圖紙上添加標註
- 表單驗證：必填字段檢查、日期有效性檢查

**任務列表頁面：**
- 表格或卡片佈局顯示任務
- 任務信息：名稱、類型、狀態、負責人、截止時間、所屬工地、所屬項目
- 狀態標籤：不同顏色區分任務狀態
- 操作按鈕：查看詳情、編輯、刪除
- 篩選功能：按狀態、按工地、按截止時間篩選

**任務詳情頁面：**
- 任務基本信息展示
- 工地圖紙預覽：顯示工地所有圖紙，支持圖紙切換
- 標註顯示：在圖紙上顯示任務相關的標註
- 標註管理：顯示/隱藏標註、標註列表、刪除標註
- 操作按鈕：編輯任務、返回工地、查看項目

**任務編輯頁面：**
- 任務信息編輯表單
- 工地圖紙預覽和標註編輯器
- 標註工具欄：點標記、矩形標記、文字標註、線條標註
- 標註屬性設置：顏色選擇、內容輸入
- 標註管理：標註列表、單個刪除、批量清空

## 核心功能實現要求

### 1. 圖紙上傳和處理
- 支持拖拽上傳和點擊上傳
- 文件格式驗證：只允許 PDF, JPG, JPEG, PNG, BMP, TIFF
- 文件大小限制：最大 10MB
- PDF 兼容性檢測：支持 PDF 1.5-1.7 版本
- 文件完整性驗證：自動檢測損壞文件
- 縮略圖生成：使用 pdf2image 和 Pillow 生成 16:9 比例縮略圖
- 多頁 PDF 支持：自動檢測頁數，支持頁面導航

### 2. 標註系統實現
**前端標註編輯器：**
- 使用 HTML5 Canvas 或 SVG 實現標註繪製
- 支持四種標註類型：點標記、矩形標記、文字標註、線條標註
- 標註工具欄：工具選擇、顏色選擇、撤銷/重做
- 標註交互：hover 顯示內容、點擊編輯、拖拽移動
- 標註數據格式：JSON 格式存儲坐標和屬性信息

**後端標註 API：**
- 創建標註：POST /tasks/annotation/create/
- 獲取標註：GET /tasks/{task_id}/annotations/
- 更新標註：PUT /tasks/annotation/{annotation_id}/update/
- 刪除標註：DELETE /tasks/annotation/{annotation_id}/delete/
- 批量操作：支持批量刪除、批量更新

### 3. 圖紙預覽功能
- PDF 預覽：使用 HTML embed 標籤或 PDF.js
- 圖片預覽：原生 img 標籤，支持縮放和拖拽
- 縮放控制：放大、縮小、重置、適應窗口
- 鍵盤導航：方向鍵移動、+/- 縮放、空格鍵重置
- 全屏模式：支持全屏查看圖紙

### 4. 權限和安全
- 用戶認證：Django 內建認證系統
- 權限控制：用戶只能訪問自己的項目和數據
- 文件安全：上傳文件類型檢查、文件大小限制
- CSRF 保護：所有表單包含 CSRF token
- XSS 防護：模板自動轉義用戶輸入

## 數據流程和業務邏輯

### 1. 用戶工作流程
1. 用戶註冊/登錄系統
2. 創建項目，設置項目基本信息
3. 在項目下創建工地，設置工地信息
4. 在工地中上傳圖紙（PDF/圖片）
5. 在工地中創建任務，關聯工地圖紙
6. 在任務中添加圖紙標註，標記重要位置
7. 查看任務詳情，管理標註信息
8. 通過項目/工地/任務多維度查看數據

### 2. 數據關係邏輯
- 用戶 → 項目（一對多）
- 項目 → 工地（一對多）
- 工地 → 圖紙（一對多）
- 工地 → 任務（一對多）
- 任務 → 標註（一對多）
- 圖紙 → 標註（一對多）
- 任務 ↔ 圖紙（通過標註關聯）

### 3. 核心業務規則
- 圖紙只能在工地級別上傳，不能在項目級別直接上傳
- 任務只能在工地級別創建，不能在項目級別直接創建
- 標註必須同時關聯任務和圖紙
- 標註只能在任務所屬工地的圖紙上創建
- 用戶只能訪問自己創建的項目及其下屬數據

## 技術實現細節

### 1. Django 配置
- Django 4.2.7
- SQLite 數據庫（開發環境）
- 中間件：CORS、CSRF、認證中間件
- 靜態文件：Bootstrap、Font Awesome、自定義 CSS/JS
- 媒體文件：用戶上傳的圖紙文件

### 2. Python 依賴包
```
Django==4.2.7
Pillow==10.1.0
django-cors-headers==4.3.1
python-decouple==3.8
PyPDF2==3.0.1
pdf2image==1.16.3
```

### 3. URL 路由設計
- / → 重定向到項目列表（需要登錄）
- /accounts/ → 用戶認證相關頁面
- /projects/ → 項目管理相關頁面
- /drawings/ → 圖紙管理相關頁面
- /tasks/ → 任務管理相關頁面
- /admin/ → Django 管理後台

### 4. 模板結構
- templates/base.html → 基礎模板
- templates/accounts/ → 用戶認證模板
- templates/projects/ → 項目管理模板
- templates/drawings/ → 圖紙管理模板
- templates/tasks/ → 任務管理模板

### 5. 靜態文件結構
- static/css/custom.css → 自定義樣式
- static/js/custom.js → 自定義 JavaScript
- static/images/ → 系統圖片資源

## 測試和驗收標準

### 1. 功能測試
- 用戶註冊/登錄功能正常
- 項目創建和管理功能正常
- 工地創建和管理功能正常
- 圖紙上傳和預覽功能正常
- 任務創建和管理功能正常
- 標註添加和顯示功能正常

### 2. 性能測試
- 10MB PDF 文件上傳時間 < 30秒
- 圖紙預覽加載時間 < 5秒
- 標註響應時間 < 1秒
- 頁面加載時間 < 3秒

### 3. 兼容性測試
- Chrome 100+ 瀏覽器支持
- Firefox 90+ 瀏覽器支持
- Safari 14+ 瀏覽器支持
- 響應式設計支持移動設備

### 4. 安全測試
- 文件上傳安全檢查
- 用戶權限隔離檢查
- CSRF 攻擊防護檢查
- XSS 攻擊防護檢查

請按照以上詳細要求實現完整的建築項目管理系統，確保所有功能模塊協調工作，提供優秀的用戶體驗。
