{% extends 'base.html' %}

{% block title %}编辑任务 - 建筑项目管理系统{% endblock %}

{% block extra_css %}
<style>
    /* 颜色选择器样式 */
    .color-picker-container {
        display: inline-block;
    }

    .color-options {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .color-option {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s ease;
        position: relative;
    }

    .color-option:hover {
        transform: scale(1.1);
        border-color: #333;
    }

    .color-option.active {
        border-color: #333;
        transform: scale(1.1);
        box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
    }

    .color-option.active::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
        font-weight: bold;
        text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.5);
    }

    /* 黄色选项的特殊处理 */
    .color-option[data-color="yellow"].active::after {
        color: #333;
        text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-edit"></i> 编辑任务
                    </h4>
                    <a href="{% url 'tasks:task_detail' task.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> 返回详情
                    </a>
                </div>

                <div class="card-body">
                    <form method="post" id="task-update-form">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.name.id_for_label }}" class="form-label">
                                        <i class="fas fa-tag"></i> {{ form.name.label }}
                                    </label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="text-danger small">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.task_type.id_for_label }}" class="form-label">
                                        <i class="fas fa-cogs"></i> {{ form.task_type.label }}
                                    </label>
                                    {{ form.task_type }}
                                    {% if form.task_type.errors %}
                                        <div class="text-danger small">{{ form.task_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.responsible_person.id_for_label }}" class="form-label">
                                        <i class="fas fa-user"></i> {{ form.responsible_person.label }}
                                    </label>
                                    {{ form.responsible_person }}
                                    {% if form.responsible_person.errors %}
                                        <div class="text-danger small">{{ form.responsible_person.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.status.id_for_label }}" class="form-label">
                                        <i class="fas fa-flag"></i> {{ form.status.label }}
                                    </label>
                                    {{ form.status }}
                                    {% if form.status.errors %}
                                        <div class="text-danger small">{{ form.status.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 任务日期计划 -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="start_date" class="form-label">
                                        <i class="fas fa-play"></i> 开始日期 <span class="text-danger">*</span>
                                    </label>
                                    <input type="date"
                                           name="start_date"
                                           id="start_date"
                                           class="form-control"
                                           value="{{ task.start_date|date:'Y-m-d' }}"
                                           required>
                                    <div class="form-text">任务计划开始日期</div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="end_date" class="form-label">
                                        <i class="fas fa-stop"></i> 结束日期 <span class="text-danger">*</span>
                                    </label>
                                    <input type="date"
                                           name="end_date"
                                           id="end_date"
                                           class="form-control"
                                           value="{{ task.end_date|date:'Y-m-d' }}"
                                           required>
                                    <div class="form-text">任务计划结束日期</div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="deadline" class="form-label">
                                        <i class="fas fa-calendar-alt"></i> 截止时间 <span class="text-danger">*</span>
                                    </label>
                                    <input type="date"
                                           name="deadline"
                                           id="deadline"
                                           class="form-control"
                                           value="{{ task.deadline|date:'Y-m-d' }}"
                                           required>
                                    <div class="form-text">任务最终截止时间</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'tasks:task_detail' task.pk %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> 保存更改
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 任务进度和子任务管理 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> 任务进度
                    </h5>
                </div>
                <div class="card-body">
                    {% with progress=task.get_progress_percentage %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="progress flex-grow-1 me-3" style="height: 25px;">
                            <div class="progress-bar
                                {% if progress == 100 %}bg-success
                                {% elif progress >= 75 %}bg-info
                                {% elif progress >= 50 %}bg-warning
                                {% else %}bg-danger
                                {% endif %}"
                                role="progressbar"
                                style="width: {{ progress }}%"
                                aria-valuenow="{{ progress }}"
                                aria-valuemin="0"
                                aria-valuemax="100">
                                <span class="fw-bold">{{ progress }}%</span>
                            </div>
                        </div>
                        <span class="text-muted">{{ progress }}%</span>
                    </div>
                    {% with stats=task.get_subtask_stats %}
                    {% if stats.total > 0 %}
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="text-success">
                                <h6 class="mb-0">{{ stats.completed }}</h6>
                                <small>已完成</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-warning">
                                <h6 class="mb-0">{{ stats.in_progress }}</h6>
                                <small>进行中</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-info">
                                <h6 class="mb-0">{{ stats.pending }}</h6>
                                <small>待处理</small>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="text-secondary">
                                <h6 class="mb-0">{{ stats.open }}</h6>
                                <small>开放</small>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <small class="text-muted">基于任务状态的进度</small>
                    {% endif %}
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>

            <!-- 子任务管理 -->
            {% if task.subtasks.exists or not task.parent_task %}
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ul"></i> 子任务管理
                    </h5>
                    {% if not task.parent_task %}
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSubtaskModal">
                        <i class="fas fa-plus"></i> 添加子任务
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if task.subtasks.exists %}
                    <div id="subtask-list">
                        {% for subtask in task.subtasks.all %}
                        <div class="subtask-item border rounded p-3 mb-3" data-subtask-id="{{ subtask.id }}">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-1">{{ subtask.name }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-user"></i> {{ subtask.responsible_person }} |
                                        <i class="fas fa-calendar"></i> {{ subtask.deadline|date:"Y-m-d" }}
                                    </small>
                                    {% if subtask.description %}
                                    <p class="small text-muted mt-1 mb-0">{{ subtask.description }}</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm subtask-status" data-subtask-id="{{ subtask.id }}">
                                        <option value="open" {% if subtask.status == 'open' %}selected{% endif %}>开放</option>
                                        <option value="in_progress" {% if subtask.status == 'in_progress' %}selected{% endif %}>进行中</option>
                                        <option value="pending" {% if subtask.status == 'pending' %}selected{% endif %}>待处理</option>
                                        <option value="completed" {% if subtask.status == 'completed' %}selected{% endif %}>已完成</option>
                                    </select>
                                </div>
                                <div class="col-md-3 text-end">
                                    <span class="badge
                                        {% if subtask.status == 'completed' %}bg-success
                                        {% elif subtask.status == 'in_progress' %}bg-warning
                                        {% elif subtask.status == 'pending' %}bg-info
                                        {% else %}bg-secondary
                                        {% endif %}">
                                        {{ subtask.get_status_display }}
                                    </span>
                                    <button type="button" class="btn btn-outline-danger btn-sm ms-2 delete-subtask" data-subtask-id="{{ subtask.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-list-ul fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">还没有子任务</h6>
                        <p class="text-muted">点击"添加子任务"按钮创建第一个子任务</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- 标注管理区域 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt"></i> 标注管理
                        <span class="badge bg-primary ms-2">{{ task.annotations.count }} 个标注</span>
                    </h5>
                </div>

                <div class="card-body">
                    <div class="row">
                            <div class="col-md-8">
                                <!-- 图纸预览区域 -->
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>工地图纸预览与标注编辑</span>
                                            {% if worksite_drawings.count > 1 %}
                                            <select class="form-select form-select-sm" id="drawing-select" style="width: auto;">
                                                {% for drawing in worksite_drawings %}
                                                <option value="{{ drawing.pk }}" data-url="{{ drawing.file.url }}" data-name="{{ drawing.name }}">
                                                    {{ drawing.name }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                            {% elif worksite_drawings.count == 1 %}
                                            <span class="text-muted small">{{ worksite_drawings.first.name }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="btn-group" role="group">
                                            <!-- 标注工具 -->
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="add-point-btn">
                                                <i class="fas fa-circle"></i> 点标记
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" id="add-line-btn">
                                                <i class="fas fa-minus"></i> 线条
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" id="add-text-btn">
                                                <i class="fas fa-font"></i> 文字
                                            </button>
                                            <!-- 颜色选择 -->
                                            <div class="color-picker-container">
                                                <div class="color-options d-flex gap-1">
                                                    <div class="color-option active" data-color="red" style="background-color: red;" title="红色"></div>
                                                    <div class="color-option" data-color="blue" style="background-color: blue;" title="蓝色"></div>
                                                    <div class="color-option" data-color="green" style="background-color: green;" title="绿色"></div>
                                                    <div class="color-option" data-color="yellow" style="background-color: yellow;" title="黄色"></div>
                                                    <div class="color-option" data-color="orange" style="background-color: orange;" title="橙色"></div>
                                                    <div class="color-option" data-color="purple" style="background-color: purple;" title="紫色"></div>
                                                    <div class="color-option" data-color="black" style="background-color: black;" title="黑色"></div>
                                                </div>
                                                <input type="hidden" id="color-select" value="red">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-body p-0">
                                        <div id="annotation-editor" style="position: relative; height: 400px; overflow: auto;">
                                            <!-- 图片显示 -->
                                            {% if worksite_drawings.exists %}
                                            <img id="drawing-image"
                                                 src="{{ worksite_drawings.first.file.url }}"
                                                 style="max-width: 100%; max-height: 400px; object-fit: contain;"
                                                 alt="{{ worksite_drawings.first.name }}">
                                            {% else %}
                                            <div class="d-flex align-items-center justify-content-center h-100">
                                                <div class="text-center">
                                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">此工地没有图纸</p>
                                                    {% if worksite %}
                                                    <a href="{% url 'drawings:worksite_drawing_upload' worksite.pk %}" class="btn btn-primary btn-sm mt-2">
                                                        <i class="fas fa-plus me-1"></i>上传工地图纸
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}

                                            <!-- 标注编辑层 -->
                                            <div id="annotation-edit-layer"
                                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;">
                                                <!-- 标注元素将在这里显示 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <!-- 标注列表 -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">标注列表</h6>
                                    </div>
                                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                        <div id="annotation-list">
                                            {% for annotation in task.annotations.all %}
                                            <div class="annotation-item border rounded p-2 mb-2" data-annotation-id="{{ annotation.id }}">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex align-items-center mb-1">
                                                            <span class="badge bg-{{ annotation.color }} me-2">
                                                                {% if annotation.is_point %}
                                                                    <i class="fas fa-circle"></i>
                                                                {% elif annotation.is_line %}
                                                                    <i class="fas fa-minus"></i>
                                                                {% elif annotation.is_text %}
                                                                    <i class="fas fa-font"></i>
                                                                {% endif %}
                                                            </span>
                                                            <small class="text-muted">{{ annotation.get_annotation_type_display }}</small>
                                                        </div>
                                                        <div class="annotation-content" style="font-size: 0.9em;">
                                                            {{ annotation.content|truncatechars:30 }}
                                                        </div>
                                                    </div>
                                                    <div class="btn-group-vertical btn-group-sm">
                                                        <button class="btn btn-outline-primary btn-sm edit-annotation-btn"
                                                                data-annotation-id="{{ annotation.id }}">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-outline-danger btn-sm delete-annotation-btn"
                                                                data-annotation-id="{{ annotation.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加子任务模态框 -->
<div class="modal fade" id="addSubtaskModal" tabindex="-1" aria-labelledby="addSubtaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSubtaskModalLabel">
                    <i class="fas fa-plus"></i> 添加子任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subtaskForm">
                    <div class="mb-3">
                        <label for="subtaskName" class="form-label">子任务名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subtaskName" name="name" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="subtaskDescription" class="form-label">子任务描述</label>
                        <textarea class="form-control" id="subtaskDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskType" class="form-label">任务类型</label>
                                <select class="form-select" id="subtaskType" name="task_type">
                                    <option value="new_construction" {% if task.task_type == 'new_construction' %}selected{% endif %}>新建施工</option>
                                    <option value="repair" {% if task.task_type == 'repair' %}selected{% endif %}>整改修复</option>
                                    <option value="inspection" {% if task.task_type == 'inspection' %}selected{% endif %}>检查验收</option>
                                    <option value="maintenance" {% if task.task_type == 'maintenance' %}selected{% endif %}>维护保养</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskStatus" class="form-label">初始状态</label>
                                <select class="form-select" id="subtaskStatus" name="status">
                                    <option value="open" selected>开放</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="pending">待处理</option>
                                    <option value="completed">已完成</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskResponsible" class="form-label">负责人 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subtaskResponsible" name="responsible_person" required maxlength="100" value="{{ task.responsible_person }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subtaskStatus" class="form-label">初始状态</label>
                                <select class="form-select" id="subtaskStatus" name="status">
                                    <option value="open" selected>开放</option>
                                    <option value="in_progress">进行中</option>
                                    <option value="pending">待处理</option>
                                    <option value="completed">已完成</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 子任务日期计划 -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskStartDate" class="form-label">开始日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskStartDate" name="start_date" required value="{{ task.start_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskEndDate" class="form-label">结束日期 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskEndDate" name="end_date" required value="{{ task.end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subtaskDeadline" class="form-label">截止时间 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="subtaskDeadline" name="deadline" required value="{{ task.deadline|date:'Y-m-d' }}">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="saveSubtaskBtn">
                    <i class="fas fa-save"></i> 保存子任务
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentTool = 'none';
let currentColor = 'red';
let annotations = [];
let annotationCounter = 0;
let isDrawingLine = false;
let lineStartX = 0;
let lineStartY = 0;
let currentDrawingId = null; // 当前选择的图纸ID

// 初始化颜色选择器
document.addEventListener('DOMContentLoaded', function() {
    initializeColorPicker();
});

function initializeColorPicker() {
    const colorOptions = document.querySelectorAll('.color-option');
    const colorInput = document.getElementById('color-select');

    colorOptions.forEach(option => {
        option.addEventListener('click', function() {
            // 移除所有active类
            colorOptions.forEach(opt => opt.classList.remove('active'));

            // 添加active类到当前选择的颜色
            this.classList.add('active');

            // 更新当前颜色
            currentColor = this.dataset.color;
            colorInput.value = currentColor;

            console.log('Selected color:', currentColor);
        });
    });
}

// 加载现有标注数据
const existingAnnotations = [
    {% for annotation in task.annotations.all %}
    {
        id: {{ annotation.id }},
        type: '{{ annotation.annotation_type }}',
        drawing_id: {{ annotation.drawing.pk|default:"null" }},
        x: {{ annotation.x_coordinate }},
        y: {{ annotation.y_coordinate }},
        {% if annotation.end_x %}endX: {{ annotation.end_x }},{% endif %}
        {% if annotation.end_y %}endY: {{ annotation.end_y }},{% endif %}
        color: '{{ annotation.color }}',
        content: '{{ annotation.content|escapejs }}',
        page: {{ annotation.page_number }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Task update page loaded');
    console.log('Task ID: {{ task.id }}');
    console.log('Annotations count: {{ task.annotations.count }}');
    console.log('Existing annotations:', existingAnnotations);

    // 初始化当前图纸ID
    initializeCurrentDrawingId();

    // 初始化标注编辑器
    initializeAnnotationEditor();

    // 绑定工具按钮事件
    bindToolEvents();

    // 绑定标注管理事件
    bindAnnotationEvents();

    // 绑定图纸切换事件
    bindDrawingSwitchEvents();

    // 渲染现有标注
    renderExistingAnnotations();

    // 初始化子任务管理
    initSubtaskManagement();

    // 初始化任务日期验证
    initTaskDateValidation();
});

// 初始化当前图纸ID
function initializeCurrentDrawingId() {
    const drawingSelector = document.getElementById('drawing-select');

    if (drawingSelector && drawingSelector.options.length > 0) {
        // 有多张图纸时，使用第一张图纸作为默认选择
        currentDrawingId = parseInt(drawingSelector.options[0].value);
        console.log('Initialized with multiple drawings - first drawing ID:', currentDrawingId);
    } else {
        // 只有一张图纸时，直接使用该图纸的ID
        {% if worksite_drawings.count == 1 %}
        currentDrawingId = {{ worksite_drawings.first.pk }};
        console.log('Initialized with single drawing - ID:', currentDrawingId);
        {% else %}
        console.log('No drawings available');
        {% endif %}
    }

    console.log('Current drawing ID initialized to:', currentDrawingId, 'Type:', typeof currentDrawingId);
}

// 初始化标注编辑器
function initializeAnnotationEditor() {
    const editLayer = document.getElementById('annotation-edit-layer');
    const drawingImage = document.getElementById('drawing-image');

    if (!editLayer || !drawingImage) {
        console.error('Annotation editor elements not found');
        return;
    }

    // 设置编辑层尺寸
    drawingImage.onload = function() {
        const rect = drawingImage.getBoundingClientRect();
        editLayer.style.width = rect.width + 'px';
        editLayer.style.height = rect.height + 'px';
        console.log('Edit layer size set:', rect.width, 'x', rect.height);
    };

    // 绑定点击事件
    editLayer.addEventListener('click', handleEditLayerClick);
}

// 绑定工具按钮事件
function bindToolEvents() {
    const addPointBtn = document.getElementById('add-point-btn');
    const addLineBtn = document.getElementById('add-line-btn');
    const addTextBtn = document.getElementById('add-text-btn');
    const colorSelect = document.getElementById('color-select');

    if (addPointBtn) {
        addPointBtn.addEventListener('click', () => selectTool('point'));
    }
    if (addLineBtn) {
        addLineBtn.addEventListener('click', () => selectTool('line'));
    }
    if (addTextBtn) {
        addTextBtn.addEventListener('click', () => selectTool('text'));
    }
    // 颜色选择现在通过颜色块处理，不需要select事件
}

// 绑定标注管理事件
function bindAnnotationEvents() {
    // 编辑按钮
    document.querySelectorAll('.edit-annotation-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const annotationId = this.dataset.annotationId;
            editAnnotation(annotationId);
        });
    });

    // 删除按钮
    document.querySelectorAll('.delete-annotation-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const annotationId = this.dataset.annotationId;
            deleteAnnotation(annotationId);
        });
    });
}

// 绑定图纸切换事件
function bindDrawingSwitchEvents() {
    const drawingSelect = document.getElementById('drawing-select');
    const drawingImage = document.getElementById('drawing-image');

    if (drawingSelect && drawingImage) {
        drawingSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const imageUrl = selectedOption.dataset.url;
            const imageName = selectedOption.dataset.name;
            const drawingId = selectedOption.value;

            if (imageUrl) {
                drawingImage.src = imageUrl;
                drawingImage.alt = imageName;

                // 更新当前图纸ID (转换为数字)
                currentDrawingId = parseInt(drawingId);
                console.log('Switched to drawing:', imageName, 'ID:', currentDrawingId, 'Type:', typeof currentDrawingId);

                // 重新渲染当前图纸的标注
                renderExistingAnnotations();
            }
        });
    }
}

// 选择工具
function selectTool(toolType) {
    currentTool = toolType;
    currentColor = document.getElementById('color-select').value;

    // 更新按钮状态
    document.querySelectorAll('[id^="add-"]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.getElementById(`add-${toolType}-btn`).classList.add('active');

    console.log('Tool selected:', toolType, 'Color:', currentColor);

    // 更新光标
    const editLayer = document.getElementById('annotation-edit-layer');
    if (editLayer) {
        editLayer.style.cursor = toolType === 'text' ? 'text' : 'crosshair';
    }
}

// 处理编辑层点击
function handleEditLayerClick(e) {
    if (currentTool === 'none') {
        alert('请先选择标注工具');
        return;
    }

    const rect = e.target.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    console.log('Edit layer clicked:', x, y, 'Tool:', currentTool);

    if (currentTool === 'point') {
        createNewPointAnnotation(x, y);
    } else if (currentTool === 'line') {
        handleLineDrawing(x, y);
    } else if (currentTool === 'text') {
        createNewTextAnnotation(x, y);
    }
}

// 创建新的点标注
function createNewPointAnnotation(x, y) {
    const content = prompt('请输入标注内容：');
    if (!content) return;

    const annotationData = {
        type: 'point',
        x_coordinate: x,
        y_coordinate: y,
        color: currentColor,
        content: content
    };

    saveNewAnnotation(annotationData);
}

// 创建新的文字标注
function createNewTextAnnotation(x, y) {
    const content = prompt('请输入文字内容：');
    if (!content) return;

    const annotationData = {
        type: 'text',
        x_coordinate: x,
        y_coordinate: y,
        color: currentColor,
        content: content
    };

    saveNewAnnotation(annotationData);
}

// 处理线条绘制
function handleLineDrawing(x, y) {
    if (!isDrawingLine) {
        isDrawingLine = true;
        lineStartX = x;
        lineStartY = y;
        alert('请点击线条终点');
    } else {
        isDrawingLine = false;
        const content = prompt('请输入线条说明：');
        if (!content) return;

        const annotationData = {
            type: 'line',
            x_coordinate: lineStartX,
            y_coordinate: lineStartY,
            end_x: x,
            end_y: y,
            color: currentColor,
            content: content
        };

        saveNewAnnotation(annotationData);
    }
}

// 保存新标注
function saveNewAnnotation(annotationData) {
    console.log('Saving new annotation:', annotationData);
    console.log('Using current drawing ID:', currentDrawingId);

    if (!currentDrawingId) {
        alert('无法确定当前图纸，请刷新页面重试');
        return;
    }

    // 直接创建标注记录
    fetch('/tasks/annotation/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            task_id: {{ task.id }},
            drawing_id: currentDrawingId,
            annotation_type: annotationData.type,
            x_coordinate: annotationData.x_coordinate,
            y_coordinate: annotationData.y_coordinate,
            end_x: annotationData.end_x,
            end_y: annotationData.end_y,
            color: annotationData.color,
            content: annotationData.content,
            page_number: 1
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            location.reload(); // 重新加载页面显示新标注
        } else {
            alert('保存失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        alert('保存失败：' + error.message);
    });
}

// 编辑标注
function editAnnotation(annotationId) {
    // 获取当前标注信息
    const currentAnnotation = existingAnnotations.find(a => a.id == annotationId);
    if (!currentAnnotation) {
        alert('标注信息未找到');
        return;
    }

    const newContent = prompt('请输入新的标注内容：', currentAnnotation.content);
    if (newContent === null) return;

    // 颜色选择
    const colors = ['red', 'blue', 'green', 'yellow', 'orange', 'purple', 'black'];
    const colorNames = ['红色', '蓝色', '绿色', '黄色', '橙色', '紫色', '黑色'];

    let colorChoice = '';
    for (let i = 0; i < colors.length; i++) {
        colorChoice += `${i + 1}. ${colorNames[i]}\n`;
    }

    const colorIndex = prompt(`请选择颜色（输入数字1-7）：\n${colorChoice}`, '1');
    if (colorIndex === null) return;

    const selectedColor = colors[parseInt(colorIndex) - 1] || currentAnnotation.color;

    fetch(`/tasks/annotation/${annotationId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            content: newContent,
            color: selectedColor
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('更新失败：' + data.error);
        }
    });
}

// 删除标注
function deleteAnnotation(annotationId) {
    if (!confirm('确认删除此标注？')) return;

    fetch(`/tasks/annotation/${annotationId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('删除失败：' + data.error);
        }
    });
}

// 渲染现有标注
function renderExistingAnnotations() {
    const editLayer = document.getElementById('annotation-edit-layer');
    if (!editLayer) return;

    // 清除现有标注
    editLayer.innerHTML = '';

    // 只渲染当前图纸的标注 (确保类型匹配)
    const currentAnnotations = existingAnnotations.filter(annotation => {
        const annotationDrawingId = annotation.drawing_id;
        const currentId = currentDrawingId;

        console.log('Comparing annotation drawing_id:', annotationDrawingId, 'type:', typeof annotationDrawingId,
                   'with current drawing_id:', currentId, 'type:', typeof currentId);

        return annotationDrawingId === currentId ||
               (annotationDrawingId === null && currentId === null);
    });

    console.log('Rendering annotations for drawing ID:', currentDrawingId, 'Type:', typeof currentDrawingId);
    console.log('Total annotations:', existingAnnotations.length);
    console.log('Filtered annotations:', currentAnnotations.length);
    console.log('Filtered annotation details:', currentAnnotations);

    currentAnnotations.forEach(annotation => {
        const element = createAnnotationElement(annotation);
        editLayer.appendChild(element);
    });
}

// 创建标注元素
function createAnnotationElement(annotation) {
    const element = document.createElement('div');
    element.className = 'annotation-display';
    element.dataset.annotationId = annotation.id;

    if (annotation.type === 'point') {
        element.style.cssText = `
            position: absolute;
            left: ${annotation.x - 6}px;
            top: ${annotation.y - 6}px;
            width: 12px;
            height: 12px;
            background-color: ${annotation.color};
            border: 2px solid ${getDarkerColor(annotation.color)};
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        `;
        element.title = annotation.content;
    } else if (annotation.type === 'line') {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');

        const minX = Math.min(annotation.x, annotation.endX);
        const minY = Math.min(annotation.y, annotation.endY);
        const width = Math.abs(annotation.endX - annotation.x) + 10;
        const height = Math.abs(annotation.endY - annotation.y) + 10;

        svg.style.cssText = `
            position: absolute;
            left: ${minX - 5}px;
            top: ${minY - 5}px;
            width: ${width}px;
            height: ${height}px;
            cursor: pointer;
            z-index: 10;
        `;

        line.setAttribute('x1', annotation.x - minX + 5);
        line.setAttribute('y1', annotation.y - minY + 5);
        line.setAttribute('x2', annotation.endX - minX + 5);
        line.setAttribute('y2', annotation.endY - minY + 5);
        line.setAttribute('stroke', annotation.color);
        line.setAttribute('stroke-width', '3');

        svg.appendChild(line);
        element.appendChild(svg);
        element.title = annotation.content;
    } else if (annotation.type === 'text') {
        element.style.cssText = `
            position: absolute;
            left: ${annotation.x}px;
            top: ${annotation.y - 16}px;
            background: rgba(255,255,255,0.9);
            color: ${annotation.color};
            font-weight: bold;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid ${annotation.color};
            cursor: pointer;
            z-index: 10;
            max-width: 150px;
            word-wrap: break-word;
        `;
        element.textContent = annotation.content;
    }

    return element;
}

// 获取更深的颜色
function getDarkerColor(color) {
    const colorMap = {
        'red': 'darkred',
        'blue': 'darkblue',
        'green': 'darkgreen',
        'yellow': 'orange',
        'orange': 'darkorange',
        'purple': 'darkviolet',
        'black': 'black'
    };
    return colorMap[color] || 'black';
}

// 子任务管理功能
function initSubtaskManagement() {
    const saveSubtaskBtn = document.getElementById('saveSubtaskBtn');
    const subtaskForm = document.getElementById('subtaskForm');
    const addSubtaskModal = document.getElementById('addSubtaskModal');

    // 保存子任务
    if (saveSubtaskBtn) {
        saveSubtaskBtn.addEventListener('click', function() {
            const formData = new FormData(subtaskForm);
            const data = Object.fromEntries(formData.entries());

            // 验证必填字段
            if (!data.name || !data.responsible_person || !data.deadline) {
                alert('请填写所有必填字段');
                return;
            }

            // 发送创建请求
            fetch(`/tasks/{{ task.id }}/subtask/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(addSubtaskModal);
                    modal.hide();

                    // 重新加载页面以显示新子任务
                    location.reload();
                } else {
                    alert('创建子任务失败: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('创建子任务时发生错误');
            });
        });
    }

    // 子任务状态更新
    document.querySelectorAll('.subtask-status').forEach(select => {
        select.addEventListener('change', function() {
            const subtaskId = this.dataset.subtaskId;
            const newStatus = this.value;

            fetch(`/tasks/subtask/${subtaskId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // 更新状态徽章
                    const subtaskItem = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
                    const badge = subtaskItem.querySelector('.badge');

                    // 更新徽章样式和文本
                    badge.className = 'badge ' + getStatusBadgeClass(newStatus);
                    badge.textContent = getStatusDisplayText(newStatus);

                    // 更新进度条
                    if (result.progress !== undefined) {
                        updateProgressBar(result.progress);
                    }

                    // 显示成功消息
                    showToast('子任务状态更新成功', 'success');
                } else {
                    alert('更新子任务状态失败: ' + result.error);
                    // 恢复原状态
                    this.value = this.dataset.originalValue;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('更新子任务状态时发生错误');
                // 恢复原状态
                this.value = this.dataset.originalValue;
            });
        });

        // 保存原始值
        select.dataset.originalValue = select.value;
    });

    // 删除子任务
    document.querySelectorAll('.delete-subtask').forEach(button => {
        button.addEventListener('click', function() {
            const subtaskId = this.dataset.subtaskId;
            const subtaskItem = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
            const subtaskName = subtaskItem.querySelector('h6').textContent;

            if (confirm(`确定要删除子任务"${subtaskName}"吗？此操作不可撤销。`)) {
                fetch(`/tasks/subtask/${subtaskId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        // 移除子任务元素
                        subtaskItem.remove();

                        // 更新进度条
                        if (result.progress !== undefined) {
                            updateProgressBar(result.progress);
                        }

                        // 显示成功消息
                        showToast(result.message, 'success');

                        // 如果没有子任务了，显示空状态
                        const subtaskList = document.getElementById('subtask-list');
                        if (subtaskList && subtaskList.children.length === 0) {
                            location.reload();
                        }
                    } else {
                        alert('删除子任务失败: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除子任务时发生错误');
                });
            }
        });
    });
}

// 获取状态徽章样式
function getStatusBadgeClass(status) {
    switch(status) {
        case 'completed': return 'bg-success';
        case 'in_progress': return 'bg-warning';
        case 'pending': return 'bg-info';
        default: return 'bg-secondary';
    }
}

// 获取状态显示文本
function getStatusDisplayText(status) {
    switch(status) {
        case 'open': return '开放';
        case 'in_progress': return '进行中';
        case 'pending': return '待处理';
        case 'completed': return '已完成';
        default: return status;
    }
}

// 更新进度条
function updateProgressBar(progress) {
    const progressBar = document.querySelector('.progress-bar');
    const progressText = progressBar.querySelector('span');

    if (progressBar && progressText) {
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = progress + '%';

        // 更新进度条颜色
        progressBar.className = 'progress-bar ' + getProgressBarClass(progress);
    }
}

// 获取进度条样式
function getProgressBarClass(progress) {
    if (progress == 100) return 'bg-success';
    if (progress >= 75) return 'bg-info';
    if (progress >= 50) return 'bg-warning';
    return 'bg-danger';
}

// 显示提示消息
function showToast(message, type = 'info') {
    // 简单的提示实现，可以后续改为更美观的toast
    const alertClass = type === 'success' ? 'alert-success' : 'alert-info';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    // 3秒后自动消失
    setTimeout(() => {
        const alert = document.querySelector('.alert:last-child');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

// 任务日期验证
function initTaskDateValidation() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const deadlineInput = document.getElementById('deadline');

    function validateTaskDates() {
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        const deadline = new Date(deadlineInput.value);

        // 清除之前的验证消息
        startDateInput.setCustomValidity('');
        endDateInput.setCustomValidity('');
        deadlineInput.setCustomValidity('');

        // 验证开始日期 <= 结束日期
        if (startDate && endDate && startDate > endDate) {
            endDateInput.setCustomValidity('结束日期不能早于开始日期');
        }

        // 验证结束日期 <= 截止时间
        if (endDate && deadline && endDate > deadline) {
            deadlineInput.setCustomValidity('截止时间不能早于结束日期');
        }

        // 验证开始日期 <= 截止时间
        if (startDate && deadline && startDate > deadline) {
            deadlineInput.setCustomValidity('截止时间不能早于开始日期');
        }
    }

    // 绑定事件
    if (startDateInput && endDateInput && deadlineInput) {
        startDateInput.addEventListener('change', validateTaskDates);
        endDateInput.addEventListener('change', validateTaskDates);
        deadlineInput.addEventListener('change', validateTaskDates);

        // 初始验证
        validateTaskDates();
    }

    // 表单提交验证
    const form = document.getElementById('task-update-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            validateTaskDates();

            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
            }

            form.classList.add('was-validated');
        });
    }
}
</script>
{% endblock %}
